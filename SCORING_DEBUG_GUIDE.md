# 学生答题分数累计问题调试工具

## 问题描述

学生上课答题时，数据总是无法累计分数，卡在round1，答了10题都只记住最后一题数据，报告也是只有最后一题。

## 问题根本原因

通过代码分析，发现了以下关键问题：

### 1. 轮次管理问题
- **硬编码轮次**: 在 `submit_student_answer` 和 `judge_answers` 函数中，所有答案都被硬编码为 `round_number=1`
- **轮次覆盖**: 每次答题都会覆盖之前的 `CourseRound` 记录
- **前端状态管理**: 前端没有正确跟踪当前轮次

### 2. 数据流问题
- **轮次创建时机**: 轮次记录在答案提交时创建，而不是在题目开始时创建
- **分数计算逻辑**: 分数计算没有正确累计历史数据

## 解决方案

### 1. 修复轮次管理
- 每次学生提交答案时，自动创建新的轮次记录
- 使用动态轮次编号，而不是硬编码为1
- 确保每个轮次都有唯一的ID和编号

### 2. 增强调试系统
- 添加详细的调试日志记录
- 实时监控数据流
- 提供调试API和页面

## 新增功能

### 1. 调试工具
- **调试脚本**: `debug_scoring_system.py` - 命令行调试工具
- **调试日志系统**: `debug_logging_system.py` - 实时日志记录
- **调试页面**: `/debug` - Web界面调试工具

### 2. 调试API
- `/debug/scoring_status` - 获取系统状态
- `/debug/validate_scoring` - 验证分数计算
- `/debug/export_data` - 导出调试数据

### 3. 增强的日志记录
- 请求/响应日志
- 数据库操作日志
- 分数流程日志
- 错误日志

## 使用方法

### 1. 命令行调试
```bash
# 分析当前数据
python debug_scoring_system.py

# 分析特定班级
python debug_scoring_system.py --class-id YOUR_CLASS_ID

# 自动修复问题
python debug_scoring_system.py --fix

# 生成调试报告
python debug_scoring_system.py --report
```

### 2. Web调试界面
访问 `http://your-domain/debug` 查看实时调试信息

### 3. API调试
```bash
# 获取系统状态
curl http://your-domain/debug/scoring_status

# 验证分数计算
curl http://your-domain/debug/validate_scoring

# 导出调试数据
curl http://your-domain/debug/export_data
```

## 修复内容

### 1. submit_student_answer 函数
- ✅ 修复硬编码轮次问题
- ✅ 动态创建轮次记录
- ✅ 添加详细调试日志
- ✅ 改进错误处理

### 2. judge_answers 函数
- ✅ 修复轮次查找逻辑
- ✅ 正确累计历史分数
- ✅ 添加分数验证
- ✅ 改进数据流跟踪

### 3. 调试系统
- ✅ 实时日志记录
- ✅ 数据库操作监控
- ✅ 分数流程跟踪
- ✅ 错误诊断工具

## 测试验证

### 1. 功能测试
1. 创建班级和学生
2. 开始课程
3. 学生提交多个答案
4. 检查分数是否正确累计
5. 查看调试日志确认数据流

### 2. 调试验证
1. 访问 `/debug` 页面
2. 点击"获取系统状态"
3. 点击"验证分数计算"
4. 检查是否有异常

### 3. 数据验证
1. 运行 `python debug_scoring_system.py --report`
2. 检查生成的调试报告
3. 确认没有重复轮次或数据不一致

## 监控建议

### 1. 日常监控
- 定期访问调试页面检查系统状态
- 关注调试日志中的警告和错误
- 监控学生分数累计情况

### 2. 问题排查
- 使用调试API获取详细状态
- 导出数据进行分析
- 检查数据库中的轮次记录

### 3. 预防措施
- 定期运行数据验证
- 监控轮次编号连续性
- 检查学生提交记录完整性

## 注意事项

1. **调试日志**: 调试日志会记录到 `scoring_debug.log` 文件中
2. **性能影响**: 调试功能会增加一些性能开销，生产环境可选择性启用
3. **数据安全**: 调试API会暴露系统内部信息，请确保访问权限
4. **日志清理**: 定期清理调试日志文件，避免占用过多磁盘空间

## 故障排除

### 常见问题
1. **分数不累计**: 检查轮次记录是否正确创建
2. **重复轮次**: 运行修复脚本清理重复数据
3. **数据不一致**: 使用验证API检查数据完整性

### 联系支持
如果遇到问题，请：
1. 收集调试日志
2. 导出系统状态数据
3. 描述具体问题现象
4. 提供复现步骤
