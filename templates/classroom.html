{% extends "base.html" %}

{% block title %}Classroom Management System{% endblock %}

{% block content %}
<div class="classroom-container">
    
    <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
    <div class="top-control-bar">
        <div class="container">
            <div class="top-control-content">
                <!-- å·¦ä¾§ä¿¡æ¯åŒºåŸŸ -->
                <div class="left-info-section">
                    <div class="control-item">
                        <div class="control-label">Round</div>
                        <div class="control-value" id="roundNumber">1</div>
                    </div>
                    <div class="control-item">
                        <div class="control-label">Score</div>
                        <div class="control-value-container">
                            <button class="score-btn" id="scoreMinusBtn" onclick="changeScore(-1)">-</button>
                            <span class="control-value" id="questionScore">1</span>
                            <button class="score-btn" id="scorePlusBtn" onclick="changeScore(1)">+</button>
                        </div>
                    </div>
                    <div class="control-item">
                        <div class="control-label">Time</div>
                        <div class="control-value">
                            <i class="fas fa-clock"></i>
                            <span id="timerDisplay">00:00</span>
                        </div>
                    </div>
                </div>
                
                <!-- ä¸­é—´åŒºåŸŸ -->
                <div class="center-section">
                    <div class="answer-input-group" id="correctAnswerInput" style="display: none;">
                        <input type="text" class="correct-answer-input-field" placeholder="Correct Answer" id="correctAnswerTextInput">
                        <button id="bingoBtn" class="btn btn-warning btn-lg bingo-btn-fused">
                            <i class="fas fa-star me-2"></i>BINGO!
                        </button>
                    </div>
                    <div class="correct-answer-display" id="correctAnswerDisplay" style="display: none;">
                        <div class="correct-answer-label">Correct Answer:</div>
                        <div class="correct-answer-value" id="correctAnswerValue"></div>
                    </div>
                    <div class="progress-stats-display" id="progressStatsDisplay" style="display: none;">
                        <div class="progress-stat">
                            <div class="progress-label">Participation</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="participationBar"></div>
                                <span class="progress-percentage" id="participationPercentage">0%</span>
                            </div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-label">Accuracy</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="accuracyBar"></div>
                                <span class="progress-percentage" id="accuracyPercentage">0%</span>
                            </div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-label">Avg Time</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="timeBar"></div>
                                <span class="progress-percentage" id="timePercentage">0s</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§æŒ‰é’®åŒºåŸŸ -->
                <div class="right-action-section">
                    <button id="startBtn" class="btn btn-success btn-lg">
                        <i class="fas fa-play me-2"></i>START!
                    </button>
                    <button id="nextRoundBtn" class="btn btn-info btn-lg" style="display: none;">
                        <i class="fas fa-forward me-2"></i>Next Challenge
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å³ä¸‹è§’éšè—æŒ‰é’® -->
    <div class="hidden-controls">
        <button id="endClassBtn" class="btn btn-warning btn-sm">
            <i class="fas fa-trophy"></i>
        </button>
        <button id="resetBtn" class="btn btn-danger btn-sm">
            <i class="fas fa-refresh"></i>
        </button>
        <a href="/reports" class="btn btn-primary btn-sm">
            <i class="fas fa-chart-bar"></i>
        </a>
    </div>

    <!-- å­¦ç”Ÿç®¡ç†åŒºåŸŸ -->
    <div class="students-management-area">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="students-header">
                        <div class="header-left">
                            <i class="fas fa-users me-2"></i>
                            <span>Student Management</span>
                            <div class="student-count-display">
                                <span class="student-count-label">Students:</span>
                                <span class="student-count-number" id="studentCount">{{ students|length }}</span>
                            </div>
                        </div>
                        <div class="header-right">
                            <div class="add-student-form-inline">
                                <input type="text" id="studentNameInput" class="form-control form-control-sm" placeholder="Enter student name" style="width: 150px;">
                                <button id="addStudentBtn" class="btn btn-primary btn-sm">
                                    <i class="fas fa-plus me-1"></i>Add
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="students-grid" id="studentsGrid">
                        <!-- å­¦ç”Ÿå¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å­¦ç”ŸåŒºåŸŸ - å·²ç§»è‡³é¡¶éƒ¨æ ‡é¢˜æ  -->
    <!-- <div class="add-student-area" style="display: none;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="add-student-form">
                        <input type="text" id="studentNameInput" class="form-control" placeholder="Enter student name">
                        <button id="addStudentBtn" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>+ Add Student
                        </button>
                    </div>
                    <div class="quick-tip">Press Enter to add quickly</div>
                </div>
            </div>
        </div>
    </div> -->
</div>

<script>
console.log('JavaScript file loaded');
let classroomData = {};
let timerInterval = null;
let startTime = null;

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded event fired');
    console.log('Class ID:', '{{ class_obj.id }}');
    console.log('About to start fetch...');
    
    // å¼ºåˆ¶åˆ·æ–°å­¦ç”Ÿæ•°æ®
    console.log('About to fetch classroom data...');
    fetch('/get_classroom_data', {
        headers: {
            'X-Class-ID': '{{ class_obj.id }}'
        }
    })
        .then(response => {
            console.log('Response received:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Loaded classroom data:', data);
            classroomData = data;
            
            // ä¸è¦å¼ºåˆ¶é‡ç½®è½®æ¬¡çŠ¶æ€ï¼Œä¿æŒæœåŠ¡å™¨è¿”å›çš„çŠ¶æ€
            // classroomData.round_active = false;  // ç§»é™¤è¿™è¡Œ
            // classroomData.current_answers = {};   // ç§»é™¤è¿™è¡Œ
            // classroomData.answer_times = {};      // ç§»é™¤è¿™è¡Œ
            // classroomData.start_time = null;      // ç§»é™¤è¿™è¡Œ
            
            console.log('About to call updateStudentsDisplay');
            updateStudentsDisplay();
            updateRoundStatus();
        })
        .catch(error => {
            console.error('Error loading classroom data:', error);
            console.log('Calling updateStudentsDisplay from catch block');
            updateStudentsDisplay();
            updateRoundStatus();
        });
    
    // ç»‘å®šäº‹ä»¶
    console.log('å¼€å§‹ç»‘å®šäº‹ä»¶...');
    const startBtn = document.getElementById('startBtn');
    console.log('STARTæŒ‰é’®å…ƒç´ :', startBtn);
    
    // æ£€æŸ¥æ‰€æœ‰å…³é”®å…ƒç´ 
    const elements = {
        startBtn: document.getElementById('startBtn'),
        bingoBtn: document.getElementById('bingoBtn'),
        nextRoundBtn: document.getElementById('nextRoundBtn'),
        correctAnswerInput: document.getElementById('correctAnswerInput'),
        correctAnswerTextInput: document.getElementById('correctAnswerTextInput'),
        roundNumber: document.getElementById('roundNumber'),
        questionScore: document.getElementById('questionScore'),
        timerDisplay: document.getElementById('timerDisplay')
    };
    
    console.log('é¡µé¢å…ƒç´ æ£€æŸ¥:', Object.keys(elements).reduce((acc, key) => {
        acc[key] = !!elements[key];
        return acc;
    }, {}));
    
    if (startBtn) {
        startBtn.addEventListener('click', function(e) {
            console.log('STARTæŒ‰é’®è¢«ç‚¹å‡»ï¼');
            e.preventDefault();
            startClass();
        });
        console.log('STARTæŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
    } else {
        console.error('æ‰¾ä¸åˆ°STARTæŒ‰é’®ï¼');
    }
    
    // å®‰å…¨ç»‘å®šBINGOæŒ‰é’®äº‹ä»¶
    const bingoBtn = document.getElementById('bingoBtn');
    if (bingoBtn) {
        bingoBtn.addEventListener('click', judgeAnswers);
        console.log('BINGOæŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
    } else {
        console.error('æ‰¾ä¸åˆ°BINGOæŒ‰é’®ï¼');
    }
    
    document.getElementById('nextRoundBtn').addEventListener('click', nextRound);
    document.getElementById('resetBtn').addEventListener('click', resetClassroom);
    document.getElementById('endClassBtn').addEventListener('click', endClass);
    document.getElementById('addStudentBtn').addEventListener('click', addStudent);
    document.getElementById('studentNameInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            addStudent();
        }
    });
});

// å­¦ç”Ÿç®¡ç†åŠŸèƒ½
function addStudent() {
    const studentName = document.getElementById('studentNameInput').value.trim();
    if (!studentName) {
        alert('Please enter student name');
        return;
    }
    
    fetch('/api/add_student', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: studentName,
            class_id: '{{ class_obj.id }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ›´æ–°è¯¾å ‚æ•°æ®
            if (!classroomData.students) {
                classroomData.students = {};
            }
            classroomData.students[data.student.name] = data.student;
            updateStudentsDisplay();
            document.getElementById('studentNameInput').value = '';
            document.getElementById('studentCount').textContent = Object.keys(classroomData.students).length;
        } else {
            alert(data.error || data.message || 'Failed to add student');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error occurred while adding student');
    });
}

// é‡ç½®å­¦ç”Ÿç­”é¢˜çŠ¶æ€ï¼ˆä¿ç•™æ•°æ®å’Œå›åˆæ•°ï¼‰
function resetStudentAnswerStates() {
    Object.values(classroomData.students).forEach(student => {
        // é‡ç½®è¡¨æƒ…å’ŒåŠ¨ç”»ï¼Œä½†ä¿ç•™å…¶ä»–æ•°æ®
        student.expression = 'neutral';
        student.animation = 'none';
    });
}

// æ›´æ–°å•ä¸ªå­¦ç”Ÿçš„è¡¨æƒ…å’ŒçŠ¶æ€ï¼ˆä¸é‡æ–°åˆ›å»ºå¡ç‰‡ï¼‰
function updateStudentExpression(studentName, expression) {
    console.log(`Updating ${studentName} expression to ${expression}`);
    const studentCard = document.querySelector(`[data-student="${studentName}"]`);
    if (studentCard) {
        console.log(`Found student card for ${studentName}`);
        const emojiElement = studentCard.querySelector('.student-emoji');
        console.log(`Emoji element for ${studentName}:`, emojiElement);
        if (emojiElement) {
            let emoji = 'ğŸ˜';  // é»˜è®¤é¢æ— è¡¨æƒ…
            if (expression === 'smile') {
                emoji = 'ğŸ˜Š';
            } else if (expression === 'angry') {
                emoji = 'ğŸ˜¢';
            } else if (expression === 'embarrassed') {
                emoji = 'ğŸ˜…';
            } else if (expression === 'neutral') {
                emoji = 'ğŸ˜';
            } else if (expression === 'submitted') {
                emoji = 'ğŸ˜œ';  // å¤çµç²¾æ€ªåèˆŒå¤´æ‰®é¬¼è„¸
            } else if (expression === 'focused') {
                emoji = 'ğŸ¤”';  // ä¸“æ³¨æ€è€ƒçš„è¡¨æƒ…
            }
            console.log(`Setting emoji to ${emoji} for ${studentName}`);
            emojiElement.textContent = emoji;
        } else {
            console.log(`No emoji element found for ${studentName}`);
        }
    } else {
        console.log(`No student card found for ${studentName}`);
    }
        
    // æ›´æ–°CSSç±»
    if (studentCard) {
        studentCard.className = 'student-card';
        if (expression === 'smile') {
            studentCard.classList.add('correct-answer');
        } else if (expression === 'angry') {
            studentCard.classList.add('wrong-answer');
        } else if (expression === 'embarrassed') {
            studentCard.classList.add('no-answer');
        }
    }
}

// æ›´æ–°å­¦ç”Ÿæ˜¾ç¤ºï¼ˆä¸é‡ç½®çŠ¶æ€ï¼‰
function updateStudentsDisplay(keepStates = false) {
    console.log('updateStudentsDisplay function called');
    const studentsGrid = document.getElementById('studentsGrid');
    
    console.log('updateStudentsDisplay called, students:', Object.keys(classroomData.students || {}));
    console.log('studentsGrid:', studentsGrid);
    console.log('classroomData:', classroomData);
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å­¦ç”Ÿå¡ç‰‡å­˜åœ¨
    const existingCards = studentsGrid.querySelectorAll('.student-card');
    console.log('existingCards.length:', existingCards.length);
    
    if (existingCards.length === 0) {
        // å¦‚æœæ²¡æœ‰ç°æœ‰å¡ç‰‡ï¼Œåˆ›å»ºæ–°çš„
        console.log('Creating new student cards');
        studentsGrid.innerHTML = '';
        
        // åªæœ‰åœ¨é¡µé¢åˆå§‹åŒ–æ—¶æ‰é‡ç½®çŠ¶æ€
        if (!keepStates) {
            resetStudentAnswerStates();
        }
        
        if (classroomData.students && Object.keys(classroomData.students).length > 0) {
            Object.values(classroomData.students).forEach(student => {
                // è¿‡æ»¤æ‰æ— æ•ˆçš„å­¦ç”Ÿæ•°æ®
                if (!student || !student.name || student.name === 'undefined' || student.name === '') {
                    console.warn('è·³è¿‡æ— æ•ˆå­¦ç”Ÿæ•°æ®:', student);
                    return;
                }
                console.log('Creating card for student:', student.name);
                const studentCard = createStudentCard(student);
                studentsGrid.appendChild(studentCard);
            });
        } else {
            console.log('No students found in classroomData.students:', classroomData.students);
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            studentsGrid.innerHTML = `
                <div class="no-students-message" style="text-align: center; padding: 2rem; color: #666;">
                    <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <h3>æš‚æ— å­¦ç”Ÿ</h3>
                    <p>è¯·å…ˆæ·»åŠ å­¦ç”Ÿåˆ°è¯¾å ‚ä¸­</p>
                </div>
            `;
        }
    } else {
        console.log('Updating existing student cards');
        // å¦‚æœæœ‰ç°æœ‰å¡ç‰‡ï¼Œåªæ›´æ–°ç»Ÿè®¡æ•°æ®ï¼Œä¸é‡æ–°åˆ›å»ºå¡ç‰‡
        Object.values(classroomData.students).forEach(student => {
            // è¿‡æ»¤æ‰æ— æ•ˆçš„å­¦ç”Ÿæ•°æ®
            if (!student || !student.name || student.name === 'undefined' || student.name === '') {
                console.warn('è·³è¿‡æ— æ•ˆå­¦ç”Ÿæ•°æ®:', student);
                return;
            }
            const studentCard = document.querySelector(`[data-student="${student.name}"]`);
            if (studentCard) {
                // æ£€æŸ¥å¹¶åˆ›å»ºstatså…ƒç´ ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                let statsDiv = document.getElementById(`stats-${student.name}`);
                if (!statsDiv) {
                    console.log(`å­¦ç”Ÿ ${student.name} çš„statså…ƒç´ ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º...`);
                    statsDiv = document.createElement('div');
                    statsDiv.className = 'student-stats';
                    statsDiv.id = `stats-${student.name}`;
                    statsDiv.style.display = 'none';
                    statsDiv.innerHTML = `
                        <div class="stat-item">
                            <span class="stat-label">Score</span>
                            <span class="stat-value">${student.score}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Rounds</span>
                            <span class="stat-value">${student.total_rounds || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Acc</span>
                            <span class="stat-value">${student.total_rounds ? Math.round((student.correct_rounds || 0) / student.total_rounds * 100) : 0}%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Answer</span>
                            <span class="stat-value">${student.last_answer || '-'}</span>
                        </div>
                    `;
                    studentCard.appendChild(statsDiv);
                    console.log(`å­¦ç”Ÿ ${student.name} çš„statså…ƒç´ å·²åˆ›å»º`);
                }
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                const scoreElement = statsDiv.querySelector('.stat-item:nth-child(1) .stat-value');
                const roundsElement = statsDiv.querySelector('.stat-item:nth-child(2) .stat-value');
                const accElement = statsDiv.querySelector('.stat-item:nth-child(3) .stat-value');
                const lastElement = statsDiv.querySelector('.stat-item:nth-child(4) .stat-value');
                
                console.log(`æ›´æ–°å­¦ç”Ÿ ${student.name} çš„ç»Ÿè®¡æ•°æ®:`, {
                    score: student.score,
                    total_rounds: student.total_rounds,
                    correct_rounds: student.correct_rounds,
                    last_answer: student.last_answer,
                    expression: student.expression
                });
                
                if (scoreElement) {
                    scoreElement.textContent = student.score;
                    console.log(`å­¦ç”Ÿ ${student.name} Scoreæ›´æ–°ä¸º:`, student.score);
                }
                if (roundsElement) {
                    roundsElement.textContent = student.total_rounds || 0;
                    console.log(`å­¦ç”Ÿ ${student.name} Roundsæ›´æ–°ä¸º:`, student.total_rounds || 0);
                }
                if (accElement) {
                    const accValue = student.total_rounds ? Math.round((student.correct_rounds || 0) / student.total_rounds * 100) : 0;
                    accElement.textContent = accValue + '%';
                    console.log(`å­¦ç”Ÿ ${student.name} Accæ›´æ–°ä¸º:`, accValue + '%');
                }
                if (lastElement) {
                    lastElement.textContent = student.last_answer || '-';
                    console.log(`å­¦ç”Ÿ ${student.name} Answeræ›´æ–°ä¸º:`, student.last_answer || '-');
                }
                
                // æ›´æ–°è¡¨æƒ…
                updateStudentExpression(student.name, student.expression);
                
                // æ›´æ–°CSSç±»
                studentCard.className = 'student-card';
                if (student.expression === 'smile') {
                    studentCard.classList.add('correct-answer');
                } else if (student.expression === 'angry') {
                    studentCard.classList.add('wrong-answer');
                } else                 if (student.expression === 'embarrassed') {
                    studentCard.classList.add('no-answer');
                }
            } else {
                // æ–°å­¦ç”Ÿï¼Œåˆ›å»ºæ–°å¡ç‰‡
                console.log(`åˆ›å»ºæ–°å­¦ç”Ÿå¡ç‰‡: ${student.name}`);
                const studentCard = createStudentCard(student);
                studentsGrid.appendChild(studentCard);
            }
        });
    }
}

// åˆ›å»ºå­¦ç”Ÿå¡ç‰‡
function createStudentCard(student) {
    const card = document.createElement('div');
    
    // æ ¹æ®å­¦ç”ŸçŠ¶æ€æ·»åŠ CSSç±»
    let cardClass = 'student-card';
    if (student.expression === 'smile') {
        cardClass += ' correct-answer';
    } else if (student.expression === 'angry') {
        cardClass += ' wrong-answer';
    } else if (student.expression === 'embarrassed') {
        cardClass += ' no-answer';
    }
    
    // æ ¹æ®è¡¨æƒ…é€‰æ‹©emoji
    let emoji = 'ğŸ˜';  // é»˜è®¤é¢æ— è¡¨æƒ…
    if (student.expression === 'smile') {
        emoji = 'ğŸ˜Š';
    } else if (student.expression === 'angry') {
        emoji = 'ğŸ˜¢';
    } else if (student.expression === 'embarrassed') {
        emoji = 'ğŸ˜…';
    } else if (student.expression === 'neutral') {
        emoji = 'ğŸ˜';  // é¢æ— è¡¨æƒ…
    } else if (student.expression === 'submitted') {
        emoji = 'ğŸ˜œ';  // å¤çµç²¾æ€ªåèˆŒå¤´æ‰®é¬¼è„¸
    } else if (student.expression === 'focused') {
        emoji = 'ğŸ¤”';  // ä¸“æ³¨æ€è€ƒçš„è¡¨æƒ…
    }
    
    // æ ¹æ®åŠ¨ç”»çŠ¶æ€æ·»åŠ åŠ¨ç”»ç±» - åªæœ‰ç­”å¯¹çš„å­¦ç”Ÿæ‰æ™ƒåŠ¨
    let animationClass = '';
    if (student.expression === 'smile' && student.animation === 'celebration') {
        animationClass = ' correct-bounce-animation';
    }
    
    card.className = cardClass + animationClass;
    card.setAttribute('data-student', student.name);
    card.innerHTML = `
        <div class="student-avatar" style="background-color: ${student.avatar_color}">
            <span class="student-emoji">${emoji}</span>
        </div>
        <div class="student-name">${student.name}</div>
        <div class="student-input-group" id="input-group-${student.name}">
            <input type="text" class="form-control student-answer-input" placeholder="Answer" data-student="${student.name}">
            <button class="btn btn-sm btn-outline-primary submit-btn" data-student="${student.name}">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="student-submitted" id="submitted-${student.name}" style="display: none;">
            <span class="submitted-text">Submitted</span>
            <span class="submitted-time" id="submitted-time-${student.name}"></span>
        </div>
        <div class="student-result" id="result-${student.name}" style="display: none;">
            <span class="result-text"></span>
        </div>
        <div class="student-stats" id="stats-${student.name}" style="display: none;">
            <div class="stat-item">
                <span class="stat-label">Score</span>
                <span class="stat-value">${student.score}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Rounds</span>
                <span class="stat-value">${student.total_rounds || 0}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Acc</span>
                <span class="stat-value">${student.total_rounds ? Math.round((student.correct_rounds || 0) / student.total_rounds * 100) : 0}%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Answer</span>
                <span class="stat-value">${student.last_answer || '-'}</span>
            </div>
        </div>
        <div class="student-status" id="status-${student.name}"></div>
    `;
    
    // ç»‘å®šæäº¤æŒ‰é’®äº‹ä»¶
    const submitBtn = card.querySelector('.submit-btn');
    const answerInput = card.querySelector('.student-answer-input');
    
    submitBtn.addEventListener('click', function() {
        submitStudentAnswer(student.name, answerInput.value);
    });
    
    answerInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            submitStudentAnswer(student.name, answerInput.value);
        }
    });
    
    return card;
}

// æäº¤å­¦ç”Ÿç­”æ¡ˆ
function submitStudentAnswer(studentName, answer) {
    if (!answer.trim()) {
        alert('Please enter an answer');
        return;
    }
    
    // æ£€æŸ¥è¯¾å ‚æ˜¯å¦å·²å¼€å§‹
    if (!classroomData.round_active) {
        alert('Please wait for the teacher to start the round!');
        return;
    }
    
    // è®¡ç®—ç­”é¢˜æ—¶é—´
    let answerTime = 0;
    if (startTime) {
        answerTime = (Date.now() - startTime) / 1000; // è½¬æ¢ä¸ºç§’
    }
    
    fetch('/submit_student_answer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Class-ID': '{{ class_obj.id }}'
        },
        body: JSON.stringify({
            student_name: studentName,
            answer: answer,
            answer_time: answerTime
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ›´æ–°å­¦ç”Ÿè¡¨æƒ…ä¸ºsubmitted
            if (classroomData.students[studentName]) {
                classroomData.students[studentName].expression = 'submitted';
            }
            
            // éšè—è¾“å…¥æ å’ŒæŒ‰é’®ï¼Œæ˜¾ç¤ºSubmittedå’Œæ—¶é—´
            const inputGroup = document.getElementById(`input-group-${studentName}`);
            const submittedDiv = document.getElementById(`submitted-${studentName}`);
            const submittedTimeDiv = document.getElementById(`submitted-time-${studentName}`);
            
            if (inputGroup) {
                inputGroup.style.display = 'none';
            }
            if (submittedDiv) {
                submittedDiv.style.display = 'block';
            }
            
            // æ˜¾ç¤ºç­”é¢˜æ—¶é—´ - ç›´æ¥ä½¿ç”¨å‰ç«¯è®¡ç®—çš„æ—¶é—´
            if (submittedTimeDiv) {
                submittedTimeDiv.textContent = ` (${Math.round(answerTime)}s)`;
            }
            
            // æ›´æ–°æœ¬åœ°å­¦ç”Ÿæ•°æ®ä¸­çš„ç­”é¢˜æ—¶é—´
            if (classroomData.students[studentName]) {
                classroomData.students[studentName].last_answer_time = answerTime;
            }
            
            // åªæ›´æ–°è¡¨æƒ…ï¼Œä¸é‡æ–°åˆ›å»ºæ•´ä¸ªå¡ç‰‡
            updateStudentExpression(studentName, 'submitted');
        } else {
            alert(data.message || 'Failed to submit answer');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error occurred while submitting answer');
    });
}

// å¼€å§‹è¯¾å ‚
function startClass() {
    console.log('startClasså‡½æ•°è¢«è°ƒç”¨');
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å­¦ç”Ÿ
    if (!classroomData.students || Object.keys(classroomData.students).length === 0) {
        alert('è¯·å…ˆæ·»åŠ å­¦ç”Ÿåˆ°è¯¾å ‚ä¸­ï¼');
        return;
    }
    
    // ç®€å•çš„UIæ›´æ–°æµ‹è¯•
    const startBtn = document.getElementById('startBtn');
    const bingoBtn = document.getElementById('bingoBtn');
    const correctAnswerInput = document.getElementById('correctAnswerInput');
    
    console.log('æ‰¾åˆ°çš„å…ƒç´ :', {
        startBtn: !!startBtn,
        bingoBtn: !!bingoBtn,
        correctAnswerInput: !!correctAnswerInput
    });
    
    if (startBtn) {
        startBtn.style.display = 'none';
        console.log('STARTæŒ‰é’®å·²éšè—');
    }
    
    if (bingoBtn) {
        bingoBtn.style.display = 'inline-block';
        console.log('BINGOæŒ‰é’®å·²æ˜¾ç¤º');
    }
    
    if (correctAnswerInput) {
        correctAnswerInput.style.display = 'flex';
        console.log('æ­£ç¡®ç­”æ¡ˆè¾“å…¥æ¡†å·²æ˜¾ç¤º');
    }
    
    // ç¦ç”¨åˆ†æ•°è°ƒæ•´æŒ‰é’®
    const scoreMinusBtn = document.getElementById('scoreMinusBtn');
    const scorePlusBtn = document.getElementById('scorePlusBtn');
    if (scoreMinusBtn) scoreMinusBtn.disabled = true;
    if (scorePlusBtn) scorePlusBtn.disabled = true;
    
    // å‘é€è¯·æ±‚ - å…ˆåˆ›å»ºè¯¾ç¨‹ï¼Œç„¶åå¼€å§‹ç­”é¢˜
    fetch('/api/start_course', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Class-ID': '{{ class_obj.id }}'
        },
        body: JSON.stringify({
            class_id: '{{ class_obj.id }}',
            course_name: 'è¯¾å ‚ ' + new Date().toLocaleString('zh-CN')
        })
    })
    .then(response => {
        console.log('åˆ›å»ºè¯¾ç¨‹å“åº”:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('åˆ›å»ºè¯¾ç¨‹æ•°æ®:', data);
        if (data.success) {
            console.log('è¯¾ç¨‹åˆ›å»ºæˆåŠŸï¼Œç°åœ¨å¼€å§‹ç­”é¢˜');
            
            // å¼€å§‹ç­”é¢˜
            return fetch('/api/start_class', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Class-ID': '{{ class_obj.id }}'
                },
                body: JSON.stringify({
                    class_id: '{{ class_obj.id }}'
                })
            });
        } else {
            throw new Error(data.message || 'åˆ›å»ºè¯¾ç¨‹å¤±è´¥');
        }
    })
    .then(response => {
        console.log('å¼€å§‹ç­”é¢˜å“åº”:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('å¼€å§‹ç­”é¢˜æ•°æ®:', data);
        if (data.success) {
            console.log('ç­”é¢˜å¼€å§‹æˆåŠŸ');
            // ç®€å•çš„çŠ¶æ€æ›´æ–°
            classroomData.round_active = true;
            classroomData.start_time = Date.now();
            startTime = Date.now();
            
            // å¼€å§‹è®¡æ—¶
            startTimer();
            console.log('è®¡æ—¶å™¨å·²å¯åŠ¨');
            
            // æ”¹å˜æ‰€æœ‰å­¦ç”Ÿè¡¨æƒ…ä¸ºä¸“æ³¨çŠ¶æ€
            setTimeout(() => {
                console.log('å‡†å¤‡è°ƒç”¨changeAllStudentsToFocusedï¼Œå½“å‰classroomData:', classroomData);
                console.log('å­¦ç”Ÿæ•°æ®:', classroomData.students);
                changeAllStudentsToFocused();
                console.log('å­¦ç”Ÿè¡¨æƒ…å·²æ›´æ–°ä¸ºä¸“æ³¨çŠ¶æ€');
            }, 100);
        } else {
            throw new Error(data.message || 'å¼€å§‹ç­”é¢˜å¤±è´¥');
        }
    })
    .catch(error => {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        alert('å¼€å§‹è¯¾ç¨‹å¤±è´¥: ' + error.message);
    });
}

// å¼€å§‹è®¡æ—¶
function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    
    timerInterval = setInterval(function() {
        if (startTime) {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }, 1000);
}

// åœæ­¢è®¡æ—¶
function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

// è¯„åˆ¤ç­”æ¡ˆ
    function judgeAnswers() {
        console.log('=== judgeAnswerså‡½æ•°å¼€å§‹æ‰§è¡Œ ===');
        
        try {
            const correctAnswer = document.getElementById('correctAnswerTextInput').value.trim();
            const questionScore = parseInt(document.getElementById('questionScore').textContent) || 1;
            
            console.log('æ­£ç¡®ç­”æ¡ˆ:', correctAnswer);
            console.log('é¢˜ç›®åˆ†æ•°:', questionScore);
            
            if (!correctAnswer) {
                alert('Please enter correct answer');
                return;
            }
            
            // ç«‹å³éšè—BINGOæŒ‰é’®å’Œè¾“å…¥æ¡†
            console.log('ç«‹å³éšè—BINGOç›¸å…³å…ƒç´ ...');
            const bingoBtn = document.getElementById('bingoBtn');
            const correctAnswerInput = document.getElementById('correctAnswerInput');
            
            if (bingoBtn) {
                bingoBtn.style.display = 'none';
                bingoBtn.style.visibility = 'hidden';
                console.log('BINGOæŒ‰é’®å·²éšè—');
            } else {
                console.error('æ‰¾ä¸åˆ°BINGOæŒ‰é’®ï¼');
            }
            
            if (correctAnswerInput) {
                correctAnswerInput.style.display = 'none';
                correctAnswerInput.style.visibility = 'hidden';
                console.log('è¾“å…¥æ¡†å·²éšè—');
            } else {
                console.error('æ‰¾ä¸åˆ°è¾“å…¥æ¡†ï¼');
            }
            
            // åœæ­¢è®¡æ—¶
            stopTimer();
            console.log('è®¡æ—¶å™¨å·²åœæ­¢');
        
        fetch('/judge_answers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Class-ID': '{{ class_obj.id }}'
            },
            body: JSON.stringify({
                correct_answer: correctAnswer,
                question_score: questionScore
            })
        })
        .then(response => {
            console.log('æ”¶åˆ°è¯„åˆ¤å“åº”:', response.status);
            return response.json();
        })
            .then(data => {
                console.log('è¯„åˆ¤æ•°æ®:', data);
                if (data.success) {
                    console.log('è¯„åˆ¤æˆåŠŸ');
                    console.log('è¯„åˆ¤å‰çš„è½®æ¬¡:', classroomData.current_round);
                    console.log('åç«¯è¿”å›çš„å­¦ç”Ÿæ•°æ®:', data.students);
                    console.log('åç«¯è¿”å›çš„è½®æ¬¡ç»“æœ:', data.round_result);
                    
                    classroomData.students = data.students;
                    classroomData.round_active = false;
                    
                    // ä¸è¦æ›´æ–°å½“å‰è½®æ¬¡ï¼Œè¯„åˆ¤å®Œæˆååº”è¯¥ä¿æŒå½“å‰è½®æ¬¡ä¸å˜
                    // è½®æ¬¡åªæœ‰åœ¨ç‚¹å‡»"Next Challenge"æ—¶æ‰ä¼šæ”¹å˜
                    
                    console.log('æ›´æ–°åçš„å­¦ç”Ÿæ•°æ®:', classroomData.students);
                    console.log('è¯„åˆ¤åçš„è½®æ¬¡:', classroomData.current_round);
                    
                    // æ›´æ–°å­¦ç”Ÿæ˜¾ç¤ºå’ŒçŠ¶æ€
                    updateStudentsDisplay(false);  // ä¸ä½¿ç”¨keepStatesï¼Œå¼ºåˆ¶æ›´æ–°
                    updateRoundStatus();
                    
                    // æ˜¾ç¤ºç­”é¢˜ç»“æœ - åœ¨updateStudentsDisplayä¹‹åè°ƒç”¨
                    showAnswerResults(correctAnswer);
                    
                    // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                    showCorrectAnswer(correctAnswer);
                    
                    // ç¡®ä¿BINGOæŒ‰é’®å’Œè¾“å…¥æ¡†éšè—
                    console.log('åç«¯å“åº”åå†æ¬¡ç¡®ä¿éšè—...');
                    const bingoBtn = document.getElementById('bingoBtn');
                    const correctAnswerInput = document.getElementById('correctAnswerInput');
                    
                    if (bingoBtn) {
                        bingoBtn.style.display = 'none';
                        bingoBtn.style.visibility = 'hidden';
                        console.log('åç«¯å“åº”åBINGOæŒ‰é’®å·²éšè—');
                    }
                    
                    if (correctAnswerInput) {
                        correctAnswerInput.style.display = 'none';
                        correctAnswerInput.style.visibility = 'hidden';
                        console.log('åç«¯å“åº”åè¾“å…¥æ¡†å·²éšè—');
                    }
                    
                    // æ˜¾ç¤ºå…¶ä»–å…ƒç´ 
                    const nextRoundBtn = document.getElementById('nextRoundBtn');
                    const progressStatsDisplay = document.getElementById('progressStatsDisplay');
                    
                    if (nextRoundBtn) {
                        nextRoundBtn.style.display = 'inline-block';
                        console.log('Next ChallengeæŒ‰é’®å·²æ˜¾ç¤º');
                    }
                    
                    if (progressStatsDisplay) {
                        progressStatsDisplay.style.display = 'flex';
                        console.log('è¿›åº¦ç»Ÿè®¡å·²æ˜¾ç¤º');
                    }
                
                // æ›´æ–°UI - éšè—è¾“å…¥æ¡†ï¼Œæ˜¾ç¤ºç»“æœ
                setTimeout(() => {
                    console.log('å¼€å§‹æ‰§è¡ŒUIæ›´æ–°...');
                    
                    const bingoBtn = document.getElementById('bingoBtn');
                    const nextRoundBtn = document.getElementById('nextRoundBtn');
                    const correctAnswerInput = document.getElementById('correctAnswerInput');
                    const progressStatsDisplay = document.getElementById('progressStatsDisplay');
                    
                    console.log('å»¶è¿ŸUIå…ƒç´ æ£€æŸ¥:', {
                        bingoBtn: !!bingoBtn,
                        nextRoundBtn: !!nextRoundBtn,
                        correctAnswerInput: !!correctAnswerInput,
                        progressStatsDisplay: !!progressStatsDisplay
                    });
                    
                    // å¼ºåˆ¶éšè—BINGOæŒ‰é’®
                    if (bingoBtn) {
                        bingoBtn.style.display = 'none !important';
                        bingoBtn.style.visibility = 'hidden';
                        console.log('BINGOæŒ‰é’®å·²å¼ºåˆ¶éšè—');
                    } else {
                        console.error('æ‰¾ä¸åˆ°BINGOæŒ‰é’®ï¼');
                    }
                    
                    // å¼ºåˆ¶éšè—è¾“å…¥æ¡†
                    if (correctAnswerInput) {
                        correctAnswerInput.style.display = 'none !important';
                        correctAnswerInput.style.visibility = 'hidden';
                        console.log('æ­£ç¡®ç­”æ¡ˆè¾“å…¥æ¡†å·²å¼ºåˆ¶éšè—');
                    } else {
                        console.error('æ‰¾ä¸åˆ°æ­£ç¡®ç­”æ¡ˆè¾“å…¥æ¡†ï¼');
                    }
                    
                    // æ˜¾ç¤ºNext ChallengeæŒ‰é’®
                    if (nextRoundBtn) {
                        nextRoundBtn.style.display = 'inline-block';
                        nextRoundBtn.style.visibility = 'visible';
                        console.log('Next ChallengeæŒ‰é’®å·²æ˜¾ç¤º');
                    } else {
                        console.error('æ‰¾ä¸åˆ°Next ChallengeæŒ‰é’®ï¼');
                    }
                    
                    // æ˜¾ç¤ºè¿›åº¦ç»Ÿè®¡
                    if (progressStatsDisplay) {
                        progressStatsDisplay.style.display = 'flex';
                        progressStatsDisplay.style.visibility = 'visible';
                        console.log('è¿›åº¦ç»Ÿè®¡å·²æ˜¾ç¤º');
                    } else {
                        console.error('æ‰¾ä¸åˆ°progressStatsDisplayå…ƒç´ ï¼');
                    }
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    console.log('å¼€å§‹æ›´æ–°è¿›åº¦æ¡...');
                    updateProgressBars();
                    
                    // æœ€åä¸€æ¬¡ç¡®ä¿BINGOæŒ‰é’®éšè—
                    const finalBingoBtn = document.getElementById('bingoBtn');
                    const finalCorrectAnswerInput = document.getElementById('correctAnswerInput');
                    
                    if (finalBingoBtn) {
                        finalBingoBtn.style.display = 'none';
                        finalBingoBtn.style.visibility = 'hidden';
                        console.log('æœ€ç»ˆç¡®è®¤ï¼šBINGOæŒ‰é’®å·²éšè—');
                    }
                    
                    if (finalCorrectAnswerInput) {
                        finalCorrectAnswerInput.style.display = 'none';
                        finalCorrectAnswerInput.style.visibility = 'hidden';
                        console.log('æœ€ç»ˆç¡®è®¤ï¼šè¾“å…¥æ¡†å·²éšè—');
                    }
                    
                    console.log('UIæ›´æ–°å®Œæˆï¼');
                }, 200);
                
                console.log('judgeAnswersæ‰§è¡Œå®Œæˆ');
            } else {
                console.error('è¯„åˆ¤å¤±è´¥:', data.message);
                alert(data.message || 'Failed to judge answers');
            }
        })
        .catch(error => {
            console.error('è¯„åˆ¤è¯·æ±‚å¤±è´¥:', error);
            console.error('é”™è¯¯è¯¦æƒ…:', error.message);
            console.error('é”™è¯¯å †æ ˆ:', error.stack);
            
            // ä¸æ˜¾ç¤ºalertï¼Œåªåœ¨æ§åˆ¶å°è®°å½•
            console.error('å·²æ•è·ç½‘ç»œé”™è¯¯ï¼Œä¸ä¼šæ˜¾ç¤ºå¼¹çª—');
        });
    } catch (error) {
        console.error('judgeAnswerså‡½æ•°å†…éƒ¨é”™è¯¯:', error);
        console.error('é”™è¯¯è¯¦æƒ…:', error.message);
        console.error('é”™è¯¯å †æ ˆ:', error.stack);
        
        // ä¸æ˜¾ç¤ºalertï¼Œåªåœ¨æ§åˆ¶å°è®°å½•
        console.error('å·²æ•è·é”™è¯¯ï¼Œä¸ä¼šæ˜¾ç¤ºå¼¹çª—');
    }
}

// æ˜¾ç¤ºç­”é¢˜ç»“æœ
function showAnswerResults(correctAnswer) {
    console.log('showAnswerResultså‡½æ•°è¢«è°ƒç”¨ï¼Œæ­£ç¡®ç­”æ¡ˆ:', correctAnswer);
    console.log('å½“å‰å­¦ç”Ÿæ•°æ®:', classroomData.students);
    
    Object.values(classroomData.students).forEach(student => {
        // è¿‡æ»¤æ‰æ— æ•ˆçš„å­¦ç”Ÿæ•°æ®
        if (!student || !student.name || student.name === 'undefined' || student.name === '') {
            console.warn('è·³è¿‡æ— æ•ˆå­¦ç”Ÿæ•°æ®:', student);
            return;
        }
        console.log(`å¤„ç†å­¦ç”Ÿ ${student.name}:`, student);
        console.log(`å­¦ç”Ÿ ${student.name} çš„expression:`, student.expression);
        console.log(`å­¦ç”Ÿ ${student.name} çš„score:`, student.score);
        console.log(`å­¦ç”Ÿ ${student.name} çš„total_rounds:`, student.total_rounds);
        console.log(`å­¦ç”Ÿ ${student.name} çš„last_answer:`, student.last_answer);
        
        const resultDiv = document.getElementById(`result-${student.name}`);
        const resultText = resultDiv ? resultDiv.querySelector('.result-text') : null;
        console.log(`å­¦ç”Ÿ ${student.name} çš„resultDiv:`, resultDiv);
        console.log(`å­¦ç”Ÿ ${student.name} çš„resultText:`, resultText);
        const inputGroup = document.getElementById(`input-group-${student.name}`);
        const submittedDiv = document.getElementById(`submitted-${student.name}`);
        
        if (resultDiv && resultText) {
            // éšè—è¾“å…¥æ¡†å’Œæäº¤çŠ¶æ€
            if (inputGroup) {
                inputGroup.style.display = 'none';
            }
            if (submittedDiv) {
                submittedDiv.style.display = 'none';
            }
            
            // æ˜¾ç¤ºå››ä¸ªæŒ‡æ ‡
            const statsDiv = document.getElementById(`stats-${student.name}`);
            console.log(`å­¦ç”Ÿ ${student.name} çš„ç»Ÿè®¡æ•°æ®å…ƒç´ :`, statsDiv);
            console.log(`å­¦ç”Ÿ ${student.name} çš„DOMç»“æ„:`, document.querySelector(`[data-student="${student.name}"]`));
            
            if (statsDiv) {
                console.log(`å­¦ç”Ÿ ${student.name} çš„statså…ƒç´ å­˜åœ¨ï¼Œå½“å‰display:`, statsDiv.style.display);
                statsDiv.style.display = 'block';
                console.log(`å­¦ç”Ÿ ${student.name} çš„ç»Ÿè®¡æ•°æ®å·²æ˜¾ç¤ºï¼Œæ–°display:`, statsDiv.style.display);
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®å†…å®¹
                const scoreElement = statsDiv.querySelector('.stat-item:nth-child(1) .stat-value');
                const roundsElement = statsDiv.querySelector('.stat-item:nth-child(2) .stat-value');
                const accElement = statsDiv.querySelector('.stat-item:nth-child(3) .stat-value');
                const timeElement = statsDiv.querySelector('.stat-item:nth-child(4) .stat-value');
                
                console.log(`å­¦ç”Ÿ ${student.name} çš„ç»Ÿè®¡å…ƒç´ :`, {
                    scoreElement, roundsElement, accElement, timeElement
                });
                
                if (scoreElement) {
                    scoreElement.textContent = student.score;
                    console.log(`å­¦ç”Ÿ ${student.name} Scoreæ›´æ–°ä¸º:`, student.score);
                }
                if (roundsElement) {
                    roundsElement.textContent = student.total_rounds || 0;
                    console.log(`å­¦ç”Ÿ ${student.name} Roundsæ›´æ–°ä¸º:`, student.total_rounds || 0);
                }
                if (accElement) {
                    const accValue = student.total_rounds ? Math.round((student.correct_rounds || 0) / student.total_rounds * 100) : 0;
                    accElement.textContent = accValue + '%';
                    console.log(`å­¦ç”Ÿ ${student.name} Accæ›´æ–°ä¸º:`, accValue + '%');
                }
                if (timeElement) {
                    timeElement.textContent = student.last_answer || '-';
                    console.log(`å­¦ç”Ÿ ${student.name} Answeræ›´æ–°ä¸º:`, student.last_answer || '-');
                }
            } else {
                console.error(`æ‰¾ä¸åˆ°å­¦ç”Ÿ ${student.name} çš„ç»Ÿè®¡æ•°æ®å…ƒç´ `);
                console.log(`å°è¯•æŸ¥æ‰¾å­¦ç”Ÿ ${student.name} çš„å¡ç‰‡:`, document.querySelector(`[data-student="${student.name}"]`));
            }
            
            // æ˜¾ç¤ºç­”é¢˜ç»“æœ
            resultDiv.style.display = 'block';
            
            if (student.expression === 'smile') {
                resultText.innerHTML = '<span class="result-icon">âœ“</span><span class="result-label">Correct</span>';
                resultText.className = 'result-text correct-result';
                
                // æ·»åŠ è·³åŠ¨æ•ˆæœåˆ°å­¦ç”Ÿå¡ç‰‡
                const studentCard = document.querySelector(`[data-student="${student.name}"]`);
                if (studentCard) {
                    studentCard.classList.add('correct-bounce-animation');
                }
            } else if (student.expression === 'angry') {
                resultText.innerHTML = '<span class="result-icon">âœ—</span><span class="result-label">Wrong</span>';
                resultText.className = 'result-text wrong-result';
            } else if (student.expression === 'embarrassed') {
                resultText.innerHTML = '<span class="result-icon">â—‹</span><span class="result-label">No Answer</span>';
                resultText.className = 'result-text no-answer-result';
            }
        }
    });
}

// æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
function showCorrectAnswer(correctAnswer) {
    try {
        const correctAnswerDisplay = document.getElementById('correctAnswerDisplay');
        const correctAnswerValue = document.getElementById('correctAnswerValue');
        
        console.log('showCorrectAnswerå…ƒç´ æ£€æŸ¥:', {
            correctAnswerDisplay: !!correctAnswerDisplay,
            correctAnswerValue: !!correctAnswerValue
        });
        
        if (correctAnswerDisplay && correctAnswerValue) {
            correctAnswerValue.textContent = correctAnswer;
            correctAnswerDisplay.style.display = 'block';
            
            // æ·»åŠ æ˜¾ç¤ºåŠ¨ç”»
            correctAnswerDisplay.style.animation = 'slideInDown 0.6s ease-out';
            console.log('æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤ºå·²æ›´æ–°');
        } else {
            console.error('æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤ºå…ƒç´ æœªæ‰¾åˆ°ï¼', {correctAnswerDisplay, correctAnswerValue});
        }
    } catch (error) {
        console.error('showCorrectAnswerå‡½æ•°å†…éƒ¨é”™è¯¯:', error);
        console.error('å·²æ•è·é”™è¯¯ï¼Œä¸ä¼šæ˜¾ç¤ºå¼¹çª—');
    }
}

// æ›´æ–°è¿›åº¦æ¡
function updateProgressBars() {
    try {
        console.log('updateProgressBarså‡½æ•°è¢«è°ƒç”¨');
        
        const students = Object.values(classroomData.students);
        const totalStudents = students.length;
        
        console.log('å­¦ç”Ÿæ•°æ®:', students);
        console.log('æ€»å­¦ç”Ÿæ•°:', totalStudents);
        
        // è®¡ç®—å‚ä¸äººæ•°ï¼ˆå½“å‰è½®æ¬¡æœ‰æäº¤ç­”æ¡ˆçš„å­¦ç”Ÿï¼‰
        const participatedStudents = students.filter(student => 
            student.expression === 'smile' || student.expression === 'angry' || student.expression === 'submitted'
        );
        const participationRate = totalStudents > 0 ? (participatedStudents.length / totalStudents) * 100 : 0;
        
        console.log('å‚ä¸å­¦ç”Ÿ:', participatedStudents.map(s => s.name));
        console.log('æœªå‚ä¸å­¦ç”Ÿ:', students.filter(s => !participatedStudents.includes(s)).map(s => s.name));
        
        // è®¡ç®—æ­£ç¡®ç‡ï¼ˆå‚ä¸å­¦ç”Ÿä¸­ç­”å¯¹çš„æ¯”ä¾‹ï¼‰
        const correctStudents = students.filter(student => student.expression === 'smile');
        const accuracyRate = participatedStudents.length > 0 ? (correctStudents.length / participatedStudents.length) * 100 : 0;
        
        // è®¡ç®—å¹³å‡ç­”é¢˜æ—¶é—´ - è®¡ç®—æ‰€æœ‰å‚ä¸å­¦ç”Ÿçš„å¹³å‡æ—¶é—´
        const avgTime = participatedStudents.length > 0 ? 
            participatedStudents.reduce((sum, student) => sum + (student.last_answer_time || 0), 0) / participatedStudents.length : 0;
        
        console.log('å‚ä¸ç‡:', participationRate);
        console.log('æ­£ç¡®ç‡:', accuracyRate);
        console.log('å¹³å‡æ—¶é—´:', avgTime);
        console.log('å‚ä¸å­¦ç”Ÿçš„æ—¶é—´è¯¦æƒ…:', participatedStudents.map(s => ({name: s.name, time: s.last_answer_time, expression: s.expression})));
        
        // æ›´æ–°å‚ä¸åº¦è¿›åº¦æ¡
        try {
            const participationBar = document.getElementById('participationBar');
            const participationPercentage = document.getElementById('participationPercentage');
            console.log('å‚ä¸åº¦å…ƒç´ :', {participationBar: !!participationBar, participationPercentage: !!participationPercentage});
            if (participationBar && participationPercentage) {
                participationBar.style.width = participationRate + '%';
                participationPercentage.textContent = Math.round(participationRate) + '%';
                console.log('å‚ä¸åº¦è¿›åº¦æ¡å·²æ›´æ–°ï¼Œå®½åº¦:', participationRate + '%');
            } else {
                console.error('å‚ä¸åº¦è¿›åº¦æ¡å…ƒç´ æœªæ‰¾åˆ°ï¼', {participationBar, participationPercentage});
            }
        } catch (e) {
            console.error('å‚ä¸åº¦è¿›åº¦æ¡æ›´æ–°å¤±è´¥:', e);
        }
        
        // æ›´æ–°æ­£ç¡®ç‡è¿›åº¦æ¡
        try {
            const accuracyBar = document.getElementById('accuracyBar');
            const accuracyPercentage = document.getElementById('accuracyPercentage');
            console.log('æ­£ç¡®ç‡å…ƒç´ :', {accuracyBar: !!accuracyBar, accuracyPercentage: !!accuracyPercentage});
            if (accuracyBar && accuracyPercentage) {
                accuracyBar.style.width = accuracyRate + '%';
                accuracyPercentage.textContent = Math.round(accuracyRate) + '%';
                console.log('æ­£ç¡®ç‡è¿›åº¦æ¡å·²æ›´æ–°');
            } else {
                console.error('æ­£ç¡®ç‡è¿›åº¦æ¡å…ƒç´ æœªæ‰¾åˆ°ï¼', {accuracyBar, accuracyPercentage});
            }
        } catch (e) {
            console.error('æ­£ç¡®ç‡è¿›åº¦æ¡æ›´æ–°å¤±è´¥:', e);
        }
        
        // æ›´æ–°æ—¶é—´è¿›åº¦æ¡
        try {
            const timeBar = document.getElementById('timeBar');
            const timePercentage = document.getElementById('timePercentage');
            console.log('æ—¶é—´å…ƒç´ :', {timeBar: !!timeBar, timePercentage: !!timePercentage});
            if (timeBar && timePercentage) {
                // æ—¶é—´è¿›åº¦æ¡æ˜¾ç¤ºå¹³å‡æ—¶é—´ï¼Œæœ€å¤§æ˜¾ç¤º30ç§’
                const timeRate = Math.min(avgTime / 30, 1) * 100;
                timeBar.style.width = timeRate + '%';
                timePercentage.textContent = Math.round(avgTime) + 's';
                console.log('æ—¶é—´è¿›åº¦æ¡å·²æ›´æ–°');
            } else {
                console.error('æ—¶é—´è¿›åº¦æ¡å…ƒç´ æœªæ‰¾åˆ°ï¼', {timeBar, timePercentage});
            }
        } catch (e) {
            console.error('æ—¶é—´è¿›åº¦æ¡æ›´æ–°å¤±è´¥:', e);
        }
        
        console.log('updateProgressBarsæ‰§è¡Œå®Œæˆ');
    } catch (error) {
        console.error('updateProgressBarså‡½æ•°å†…éƒ¨é”™è¯¯:', error);
        console.error('å·²æ•è·é”™è¯¯ï¼Œä¸ä¼šæ˜¾ç¤ºå¼¹çª—');
    }
}

// æ”¹å˜æ‰€æœ‰å­¦ç”Ÿè¡¨æƒ…ä¸ºä¸“æ³¨çŠ¶æ€
function changeAllStudentsToFocused() {
    console.log('Changing all students to focused state...');
    console.log('å½“å‰å­¦ç”Ÿæ•°æ®:', classroomData.students);
    
    // æ£€æŸ¥å­¦ç”Ÿæ•°æ®æ˜¯å¦å­˜åœ¨
    if (!classroomData.students || Object.keys(classroomData.students).length === 0) {
        console.warn('æ²¡æœ‰å­¦ç”Ÿæ•°æ®ï¼Œæ— æ³•æ›´æ–°è¡¨æƒ…');
        return;
    }
    
    Object.values(classroomData.students).forEach(student => {
        console.log(`Updating student ${student.name} to focused`);
        // æ›´æ–°å­¦ç”Ÿæ•°æ®ä¸­çš„è¡¨æƒ…
        student.expression = 'focused';
        
        // æ›´æ–°é¡µé¢ä¸Šçš„è¡¨æƒ…æ˜¾ç¤º
        updateStudentExpression(student.name, 'focused');
    });
    
    console.log('æ‰€æœ‰å­¦ç”Ÿè¡¨æƒ…æ›´æ–°å®Œæˆ');
}

// ä¸‹ä¸€è½®
function nextRound() {
    fetch('/next_round', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Class-ID': '{{ class_obj.id }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            classroomData.students = data.students;
            classroomData.current_round = data.round;
            classroomData.round_active = false;
            
            // æ›´æ–°è½®æ¬¡æ˜¾ç¤º
            updateRoundStatus();
            
            // é‡ç½®UI - æ·»åŠ å®‰å…¨æ£€æŸ¥
            const nextRoundBtn = document.getElementById('nextRoundBtn');
            const startBtn = document.getElementById('startBtn');
            const bingoBtn = document.getElementById('bingoBtn');
            const correctAnswerInput = document.getElementById('correctAnswerInput');
            const correctAnswerTextInput = document.getElementById('correctAnswerTextInput');
            const correctAnswerDisplay = document.getElementById('correctAnswerDisplay');
            const progressStatsDisplay = document.getElementById('progressStatsDisplay');
            const timerDisplay = document.getElementById('timerDisplay');
            
            if (nextRoundBtn) nextRoundBtn.style.display = 'none';
            if (startBtn) startBtn.style.display = 'inline-block';
            if (bingoBtn) {
                bingoBtn.style.display = 'none';
                bingoBtn.style.visibility = 'visible';
            }
            if (correctAnswerInput) {
                correctAnswerInput.style.display = 'none';
                correctAnswerInput.style.visibility = 'visible';
            }
            if (correctAnswerTextInput) correctAnswerTextInput.value = '';
            if (correctAnswerDisplay) correctAnswerDisplay.style.display = 'none';
            if (progressStatsDisplay) progressStatsDisplay.style.display = 'none';
            if (timerDisplay) timerDisplay.textContent = '00:00';
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            if (startBtn) startBtn.innerHTML = '<i class="fas fa-play me-2"></i>START!';
            
            // é‡æ–°å¯ç”¨åˆ†æ•°è°ƒæ•´æŒ‰é’®
            const scoreMinusBtn = document.getElementById('scoreMinusBtn');
            const scorePlusBtn = document.getElementById('scorePlusBtn');
            if (scoreMinusBtn) scoreMinusBtn.disabled = false;
            if (scorePlusBtn) scorePlusBtn.disabled = false;
            
            // éšè—è¿›åº¦ç»Ÿè®¡ï¼ˆæ¡å½¢å›¾ï¼‰
            if (progressStatsDisplay) progressStatsDisplay.style.display = 'none';
            
            // é‡ç½®æ‰€æœ‰å­¦ç”Ÿçš„æäº¤çŠ¶æ€å’Œè¡¨æƒ…
            Object.values(classroomData.students).forEach(student => {
                // è¿‡æ»¤æ‰æ— æ•ˆçš„å­¦ç”Ÿæ•°æ®
                if (!student || !student.name || student.name === 'undefined' || student.name === '') {
                    console.warn('è·³è¿‡æ— æ•ˆå­¦ç”Ÿæ•°æ®:', student);
                    return;
                }
                // é‡ç½®å­¦ç”Ÿè¡¨æƒ…ä¸ºæ­£å¸¸çŠ¶æ€
                student.expression = 'neutral';
                student.animation = 'none';
                
                // ç§»é™¤è·³åŠ¨æ•ˆæœ
                const studentCard = document.querySelector(`[data-student="${student.name}"]`);
                if (studentCard) {
                    studentCard.classList.remove('correct-bounce-animation');
                }
                
                // é‡ç½®è¾“å…¥æ æ˜¾ç¤º
                const inputGroup = document.getElementById(`input-group-${student.name}`);
                const submittedDiv = document.getElementById(`submitted-${student.name}`);
                const resultDiv = document.getElementById(`result-${student.name}`);
                const statsDiv = document.getElementById(`stats-${student.name}`);
                const answerInput = document.querySelector(`[data-student="${student.name}"].student-answer-input`);
                
                if (inputGroup) {
                    inputGroup.style.display = 'flex';
                }
                if (submittedDiv) {
                    submittedDiv.style.display = 'none';
                }
                if (resultDiv) {
                    resultDiv.style.display = 'none';
                }
                if (statsDiv) {
                    statsDiv.style.display = 'none';
                }
                // æ¸…ç©ºè¾“å…¥æ¡†
                if (answerInput) {
                    answerInput.value = '';
                }
            });
            
            updateStudentsDisplay(true);  // ä¿æŒæœåŠ¡å™¨è¿”å›çš„çŠ¶æ€
            
            // ç¡®ä¿æ‰€æœ‰å­¦ç”Ÿè¡¨æƒ…éƒ½é‡ç½®ä¸ºneutral
            setTimeout(() => {
                Object.values(classroomData.students).forEach(student => {
                    // è¿‡æ»¤æ‰æ— æ•ˆçš„å­¦ç”Ÿæ•°æ®
                    if (!student || !student.name || student.name === 'undefined' || student.name === '') {
                        return;
                    }
                    updateStudentExpression(student.name, 'neutral');
                });
            }, 100);
            updateRoundStatus();
        }
    })
    .catch(error => {
        console.error('Next round error:', error);
        console.log('Error details:', error.message);
        // ä¸æ˜¾ç¤ºå¼¹çª—ï¼Œåªè®°å½•é”™è¯¯
    });
}

// æ›´æ–°è½®æ¬¡çŠ¶æ€
function updateRoundStatus() {
    try {
        const roundNumber = document.getElementById('roundNumber');
        
        console.log('updateRoundStatus - å½“å‰è½®æ¬¡:', classroomData.current_round);
        
        if (roundNumber) {
            console.log('updateRoundStatus - æ›´æ–°è½®æ¬¡æ˜¾ç¤ºä¸º:', classroomData.current_round);
            roundNumber.textContent = classroomData.current_round;
        }
        
        // ä¸è¦é‡æ–°æ˜¾ç¤ºBINGOæŒ‰é’®ï¼Œä¿æŒå½“å‰çŠ¶æ€
        console.log('updateRoundStatusæ‰§è¡Œå®Œæˆï¼Œä¸æ”¹å˜BINGOæŒ‰é’®çŠ¶æ€');
    } catch (error) {
        console.error('updateRoundStatusé”™è¯¯:', error);
    }
}

// é‡ç½®è¯¾å ‚
function resetClassroom() {
    if (confirm('Are you sure you want to reset the classroom? This will clear all data.')) {
        fetch('/reset_classroom', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // é‡æ–°åŠ è½½é¡µé¢
                location.reload();
            } else {
                alert(data.message || 'Failed to reset classroom');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error occurred while resetting classroom');
        });
    }
}

// è°ƒæ•´åˆ†æ•°
function changeScore(delta) {
    const scoreElement = document.getElementById('questionScore');
    let currentScore = parseInt(scoreElement.textContent) || 1;
    let newScore = currentScore + delta;
    
    // é™åˆ¶åˆ†æ•°èŒƒå›´åœ¨1-10ä¹‹é—´
    if (newScore < 1) newScore = 1;
    if (newScore > 10) newScore = 10;
    
    scoreElement.textContent = newScore;
}

// è¯¾å ‚ç»“æŸ
function endClass() {
    if (confirm('ç¡®å®šè¦ç»“æŸè¯¾å ‚å—ï¼Ÿå°†è¿›å…¥é¢å¥–å…¸ç¤¼ï¼')) {
        // è·³è½¬åˆ°é¢å¥–å…¸ç¤¼é¡µé¢
        window.location.href = '/ceremony/{{ class_obj.id }}';
    }
}
</script>
{% endblock %}