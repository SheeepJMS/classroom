{% extends "base.html" %}

{% block title %}Classroom Management System{% endblock %}

{% block content %}
<div class="classroom-container">
    
    <!-- 顶部控制栏 -->
    <div class="top-control-bar">
        <div class="container">
            <div class="top-control-content">
                <!-- 左侧信息区域 -->
                <div class="left-info-section">
                    <div class="control-item">
                        <div class="control-label">Round</div>
                        <div class="control-value" id="roundNumber">1</div>
                    </div>
                    <div class="control-item">
                        <div class="control-label">Score</div>
                        <div class="control-value-container">
                            <button class="score-btn" id="scoreMinusBtn" onclick="changeScore(-1)">-</button>
                            <span class="control-value" id="questionScore">1</span>
                            <button class="score-btn" id="scorePlusBtn" onclick="changeScore(1)">+</button>
                        </div>
                    </div>
                    <div class="control-item">
                        <div class="control-label">Time</div>
                        <div class="control-value">
                            <i class="fas fa-clock"></i>
                            <span id="timerDisplay">00:00</span>
                        </div>
                    </div>
                </div>
                
                <!-- 中间区域 -->
                <div class="center-section">
                    <div class="answer-input-group" id="correctAnswerInput" style="display: none;">
                        <input type="text" class="correct-answer-input-field" placeholder="Correct Answer" id="correctAnswerTextInput">
                        <button id="bingoBtn" class="btn btn-warning btn-lg bingo-btn-fused">
                            <i class="fas fa-star me-2"></i>BINGO!
                        </button>
                    </div>
                    <div class="correct-answer-display" id="correctAnswerDisplay" style="display: none;">
                        <div class="correct-answer-label">Correct Answer:</div>
                        <div class="correct-answer-value" id="correctAnswerValue"></div>
                    </div>
                    <div class="progress-stats-display" id="progressStatsDisplay" style="display: none;">
                        <div class="progress-stat">
                            <div class="progress-label">Participation</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="participationBar"></div>
                                <span class="progress-percentage" id="participationPercentage">0%</span>
                            </div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-label">Accuracy</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="accuracyBar"></div>
                                <span class="progress-percentage" id="accuracyPercentage">0%</span>
                            </div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-label">Avg Time</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="timeBar"></div>
                                <span class="progress-percentage" id="timePercentage">0s</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧按钮区域 -->
                <div class="right-action-section">
                    <button id="startBtn" class="btn btn-success btn-lg">
                        <i class="fas fa-play me-2"></i>START!
                    </button>
                    <button id="nextRoundBtn" class="btn btn-info btn-lg" style="display: none;">
                        <i class="fas fa-forward me-2"></i>Next Challenge
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 右下角隐藏按钮 -->
    <div class="hidden-controls">
        <button id="endClassBtn" class="btn btn-warning btn-sm">
            <i class="fas fa-trophy"></i>
        </button>
        <button id="resetBtn" class="btn btn-danger btn-sm">
            <i class="fas fa-refresh"></i>
        </button>
        <a href="/reports" class="btn btn-primary btn-sm">
            <i class="fas fa-chart-bar"></i>
        </a>
    </div>

    <!-- 学生管理区域 -->
    <div class="students-management-area">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="students-header">
                        <div class="header-left">
                            <i class="fas fa-users me-2"></i>
                            <span>Student Management</span>
                            <div class="student-count-display">
                                <span class="student-count-label">Students:</span>
                                <span class="student-count-number" id="studentCount">{{ students|length }}</span>
                            </div>
                        </div>
                        <div class="header-right">
                            <div class="add-student-form-inline">
                                <input type="text" id="studentNameInput" class="form-control form-control-sm" placeholder="Enter student name" style="width: 150px;">
                                <button id="addStudentBtn" class="btn btn-primary btn-sm">
                                    <i class="fas fa-plus me-1"></i>Add
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="students-grid" id="studentsGrid">
                        <!-- 学生卡片将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加学生区域 - 已移至顶部标题栏 -->
    <!-- <div class="add-student-area" style="display: none;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="add-student-form">
                        <input type="text" id="studentNameInput" class="form-control" placeholder="Enter student name">
                        <button id="addStudentBtn" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>+ Add Student
                        </button>
                    </div>
                    <div class="quick-tip">Press Enter to add quickly</div>
                </div>
            </div>
        </div>
    </div> -->
</div>

<script>
console.log('JavaScript file loaded');
let classroomData = {};
let timerInterval = null;
let startTime = null;

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded event fired');
    console.log('Class ID:', '{{ class_obj.id }}');
    console.log('About to start fetch...');
    
    // 强制刷新学生数据
    console.log('About to fetch classroom data...');
    fetch('/get_classroom_data', {
        headers: {
            'X-Class-ID': '{{ class_obj.id }}'
        }
    })
        .then(response => {
            console.log('Response received:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Loaded classroom data:', data);
            classroomData = data;
            
            // 不要强制重置轮次状态，保持服务器返回的状态
            // classroomData.round_active = false;  // 移除这行
            // classroomData.current_answers = {};   // 移除这行
            // classroomData.answer_times = {};      // 移除这行
            // classroomData.start_time = null;      // 移除这行
            
            console.log('About to call updateStudentsDisplay');
            updateStudentsDisplay();
            updateRoundStatus();
        })
        .catch(error => {
            console.error('Error loading classroom data:', error);
            console.log('Calling updateStudentsDisplay from catch block');
            updateStudentsDisplay();
            updateRoundStatus();
        });
    
    // 绑定事件
    console.log('开始绑定事件...');
    const startBtn = document.getElementById('startBtn');
    console.log('START按钮元素:', startBtn);
    
    // 检查所有关键元素
    const elements = {
        startBtn: document.getElementById('startBtn'),
        bingoBtn: document.getElementById('bingoBtn'),
        nextRoundBtn: document.getElementById('nextRoundBtn'),
        correctAnswerInput: document.getElementById('correctAnswerInput'),
        correctAnswerTextInput: document.getElementById('correctAnswerTextInput'),
        roundNumber: document.getElementById('roundNumber'),
        questionScore: document.getElementById('questionScore'),
        timerDisplay: document.getElementById('timerDisplay')
    };
    
    console.log('页面元素检查:', Object.keys(elements).reduce((acc, key) => {
        acc[key] = !!elements[key];
        return acc;
    }, {}));
    
    if (startBtn) {
        startBtn.addEventListener('click', function(e) {
            console.log('START按钮被点击！');
            e.preventDefault();
            startClass();
        });
        console.log('START按钮事件绑定成功');
    } else {
        console.error('找不到START按钮！');
    }
    
    // 安全绑定BINGO按钮事件
    const bingoBtn = document.getElementById('bingoBtn');
    if (bingoBtn) {
        bingoBtn.addEventListener('click', judgeAnswers);
        console.log('BINGO按钮事件绑定成功');
    } else {
        console.error('找不到BINGO按钮！');
    }
    
    document.getElementById('nextRoundBtn').addEventListener('click', nextRound);
    document.getElementById('resetBtn').addEventListener('click', resetClassroom);
    document.getElementById('endClassBtn').addEventListener('click', endClass);
    document.getElementById('addStudentBtn').addEventListener('click', addStudent);
    document.getElementById('studentNameInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            addStudent();
        }
    });
});

// 学生管理功能
function addStudent() {
    const studentName = document.getElementById('studentNameInput').value.trim();
    if (!studentName) {
        alert('Please enter student name');
        return;
    }
    
    fetch('/api/add_student', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: studentName,
            class_id: '{{ class_obj.id }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新课堂数据
            if (!classroomData.students) {
                classroomData.students = {};
            }
            classroomData.students[data.student.name] = data.student;
            updateStudentsDisplay();
            document.getElementById('studentNameInput').value = '';
            document.getElementById('studentCount').textContent = Object.keys(classroomData.students).length;
        } else {
            alert(data.error || data.message || 'Failed to add student');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error occurred while adding student');
    });
}

// 重置学生答题状态（保留数据和回合数）
function resetStudentAnswerStates() {
    Object.values(classroomData.students).forEach(student => {
        // 重置表情和动画，但保留其他数据
        student.expression = 'neutral';
        student.animation = 'none';
    });
}

// 更新单个学生的表情和状态（不重新创建卡片）
function updateStudentExpression(studentName, expression) {
    console.log(`Updating ${studentName} expression to ${expression}`);
    const studentCard = document.querySelector(`[data-student="${studentName}"]`);
    if (studentCard) {
        console.log(`Found student card for ${studentName}`);
        const emojiElement = studentCard.querySelector('.student-emoji');
        console.log(`Emoji element for ${studentName}:`, emojiElement);
        if (emojiElement) {
            let emoji = '😐';  // 默认面无表情
            if (expression === 'smile') {
                emoji = '😊';
            } else if (expression === 'angry') {
                emoji = '😢';
            } else if (expression === 'embarrassed') {
                emoji = '😅';
            } else if (expression === 'neutral') {
                emoji = '😐';
            } else if (expression === 'submitted') {
                emoji = '😜';  // 古灵精怪吐舌头扮鬼脸
            } else if (expression === 'focused') {
                emoji = '🤔';  // 专注思考的表情
            }
            console.log(`Setting emoji to ${emoji} for ${studentName}`);
            emojiElement.textContent = emoji;
        } else {
            console.log(`No emoji element found for ${studentName}`);
        }
    } else {
        console.log(`No student card found for ${studentName}`);
    }
        
    // 更新CSS类
    if (studentCard) {
        studentCard.className = 'student-card';
        if (expression === 'smile') {
            studentCard.classList.add('correct-answer');
        } else if (expression === 'angry') {
            studentCard.classList.add('wrong-answer');
        } else if (expression === 'embarrassed') {
            studentCard.classList.add('no-answer');
        }
    }
}

// 更新学生显示（不重置状态）
function updateStudentsDisplay(keepStates = false) {
    console.log('updateStudentsDisplay function called');
    const studentsGrid = document.getElementById('studentsGrid');
    
    console.log('updateStudentsDisplay called, students:', Object.keys(classroomData.students || {}));
    console.log('studentsGrid:', studentsGrid);
    console.log('classroomData:', classroomData);
    
    // 检查是否已经有学生卡片存在
    const existingCards = studentsGrid.querySelectorAll('.student-card');
    console.log('existingCards.length:', existingCards.length);
    
    if (existingCards.length === 0) {
        // 如果没有现有卡片，创建新的
        console.log('Creating new student cards');
        studentsGrid.innerHTML = '';
        
        // 只有在页面初始化时才重置状态
        if (!keepStates) {
            resetStudentAnswerStates();
        }
        
        if (classroomData.students && Object.keys(classroomData.students).length > 0) {
            Object.values(classroomData.students).forEach(student => {
                // 过滤掉无效的学生数据
                if (!student || !student.name || student.name === 'undefined' || student.name === '') {
                    console.warn('跳过无效学生数据:', student);
                    return;
                }
                console.log('Creating card for student:', student.name);
                const studentCard = createStudentCard(student);
                studentsGrid.appendChild(studentCard);
            });
        } else {
            console.log('No students found in classroomData.students:', classroomData.students);
            // 显示提示信息
            studentsGrid.innerHTML = `
                <div class="no-students-message" style="text-align: center; padding: 2rem; color: #666;">
                    <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <h3>暂无学生</h3>
                    <p>请先添加学生到课堂中</p>
                </div>
            `;
        }
    } else {
        console.log('Updating existing student cards');
        // 如果有现有卡片，只更新统计数据，不重新创建卡片
        Object.values(classroomData.students).forEach(student => {
            // 过滤掉无效的学生数据
            if (!student || !student.name || student.name === 'undefined' || student.name === '') {
                console.warn('跳过无效学生数据:', student);
                return;
            }
            const studentCard = document.querySelector(`[data-student="${student.name}"]`);
            if (studentCard) {
                // 检查并创建stats元素（如果不存在）
                let statsDiv = document.getElementById(`stats-${student.name}`);
                if (!statsDiv) {
                    console.log(`学生 ${student.name} 的stats元素不存在，正在创建...`);
                    statsDiv = document.createElement('div');
                    statsDiv.className = 'student-stats';
                    statsDiv.id = `stats-${student.name}`;
                    statsDiv.style.display = 'none';
                    statsDiv.innerHTML = `
                        <div class="stat-item">
                            <span class="stat-label">Score</span>
                            <span class="stat-value">${student.score}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Rounds</span>
                            <span class="stat-value">${student.total_rounds || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Acc</span>
                            <span class="stat-value">${student.total_rounds ? Math.round((student.correct_rounds || 0) / student.total_rounds * 100) : 0}%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Answer</span>
                            <span class="stat-value">${student.last_answer || '-'}</span>
                        </div>
                    `;
                    studentCard.appendChild(statsDiv);
                    console.log(`学生 ${student.name} 的stats元素已创建`);
                }
                
                // 更新统计数据
                const scoreElement = statsDiv.querySelector('.stat-item:nth-child(1) .stat-value');
                const roundsElement = statsDiv.querySelector('.stat-item:nth-child(2) .stat-value');
                const accElement = statsDiv.querySelector('.stat-item:nth-child(3) .stat-value');
                const lastElement = statsDiv.querySelector('.stat-item:nth-child(4) .stat-value');
                
                console.log(`更新学生 ${student.name} 的统计数据:`, {
                    score: student.score,
                    total_rounds: student.total_rounds,
                    correct_rounds: student.correct_rounds,
                    last_answer: student.last_answer,
                    expression: student.expression
                });
                
                if (scoreElement) {
                    scoreElement.textContent = student.score;
                    console.log(`学生 ${student.name} Score更新为:`, student.score);
                }
                if (roundsElement) {
                    roundsElement.textContent = student.total_rounds || 0;
                    console.log(`学生 ${student.name} Rounds更新为:`, student.total_rounds || 0);
                }
                if (accElement) {
                    const accValue = student.total_rounds ? Math.round((student.correct_rounds || 0) / student.total_rounds * 100) : 0;
                    accElement.textContent = accValue + '%';
                    console.log(`学生 ${student.name} Acc更新为:`, accValue + '%');
                }
                if (lastElement) {
                    lastElement.textContent = student.last_answer || '-';
                    console.log(`学生 ${student.name} Answer更新为:`, student.last_answer || '-');
                }
                
                // 更新表情
                updateStudentExpression(student.name, student.expression);
                
                // 更新CSS类
                studentCard.className = 'student-card';
                if (student.expression === 'smile') {
                    studentCard.classList.add('correct-answer');
                } else if (student.expression === 'angry') {
                    studentCard.classList.add('wrong-answer');
                } else                 if (student.expression === 'embarrassed') {
                    studentCard.classList.add('no-answer');
                }
            } else {
                // 新学生，创建新卡片
                console.log(`创建新学生卡片: ${student.name}`);
                const studentCard = createStudentCard(student);
                studentsGrid.appendChild(studentCard);
            }
        });
    }
}

// 创建学生卡片
function createStudentCard(student) {
    const card = document.createElement('div');
    
    // 根据学生状态添加CSS类
    let cardClass = 'student-card';
    if (student.expression === 'smile') {
        cardClass += ' correct-answer';
    } else if (student.expression === 'angry') {
        cardClass += ' wrong-answer';
    } else if (student.expression === 'embarrassed') {
        cardClass += ' no-answer';
    }
    
    // 根据表情选择emoji
    let emoji = '😐';  // 默认面无表情
    if (student.expression === 'smile') {
        emoji = '😊';
    } else if (student.expression === 'angry') {
        emoji = '😢';
    } else if (student.expression === 'embarrassed') {
        emoji = '😅';
    } else if (student.expression === 'neutral') {
        emoji = '😐';  // 面无表情
    } else if (student.expression === 'submitted') {
        emoji = '😜';  // 古灵精怪吐舌头扮鬼脸
    } else if (student.expression === 'focused') {
        emoji = '🤔';  // 专注思考的表情
    }
    
    // 根据动画状态添加动画类 - 只有答对的学生才晃动
    let animationClass = '';
    if (student.expression === 'smile' && student.animation === 'celebration') {
        animationClass = ' correct-bounce-animation';
    }
    
    card.className = cardClass + animationClass;
    card.setAttribute('data-student', student.name);
    card.innerHTML = `
        <div class="student-avatar" style="background-color: ${student.avatar_color}">
            <span class="student-emoji">${emoji}</span>
        </div>
        <div class="student-name">${student.name}</div>
        <div class="student-input-group" id="input-group-${student.name}">
            <input type="text" class="form-control student-answer-input" placeholder="Answer" data-student="${student.name}">
            <button class="btn btn-sm btn-outline-primary submit-btn" data-student="${student.name}">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="student-submitted" id="submitted-${student.name}" style="display: none;">
            <span class="submitted-text">Submitted</span>
            <span class="submitted-time" id="submitted-time-${student.name}"></span>
        </div>
        <div class="student-result" id="result-${student.name}" style="display: none;">
            <span class="result-text"></span>
        </div>
        <div class="student-stats" id="stats-${student.name}" style="display: none;">
            <div class="stat-item">
                <span class="stat-label">Score</span>
                <span class="stat-value">${student.score}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Rounds</span>
                <span class="stat-value">${student.total_rounds || 0}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Acc</span>
                <span class="stat-value">${student.total_rounds ? Math.round((student.correct_rounds || 0) / student.total_rounds * 100) : 0}%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Answer</span>
                <span class="stat-value">${student.last_answer || '-'}</span>
            </div>
        </div>
        <div class="student-status" id="status-${student.name}"></div>
    `;
    
    // 绑定提交按钮事件
    const submitBtn = card.querySelector('.submit-btn');
    const answerInput = card.querySelector('.student-answer-input');
    
    submitBtn.addEventListener('click', function() {
        submitStudentAnswer(student.name, answerInput.value);
    });
    
    answerInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            submitStudentAnswer(student.name, answerInput.value);
        }
    });
    
    return card;
}

// 提交学生答案
function submitStudentAnswer(studentName, answer) {
    if (!answer.trim()) {
        alert('Please enter an answer');
        return;
    }
    
    // 检查课堂是否已开始
    if (!classroomData.round_active) {
        alert('Please wait for the teacher to start the round!');
        return;
    }
    
    // 计算答题时间
    let answerTime = 0;
    if (startTime) {
        answerTime = (Date.now() - startTime) / 1000; // 转换为秒
    }
    
    fetch('/submit_student_answer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Class-ID': '{{ class_obj.id }}'
        },
        body: JSON.stringify({
            student_name: studentName,
            answer: answer,
            answer_time: answerTime
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新学生表情为submitted
            if (classroomData.students[studentName]) {
                classroomData.students[studentName].expression = 'submitted';
            }
            
            // 隐藏输入栏和按钮，显示Submitted和时间
            const inputGroup = document.getElementById(`input-group-${studentName}`);
            const submittedDiv = document.getElementById(`submitted-${studentName}`);
            const submittedTimeDiv = document.getElementById(`submitted-time-${studentName}`);
            
            if (inputGroup) {
                inputGroup.style.display = 'none';
            }
            if (submittedDiv) {
                submittedDiv.style.display = 'block';
            }
            
            // 显示答题时间 - 直接使用前端计算的时间
            if (submittedTimeDiv) {
                submittedTimeDiv.textContent = ` (${Math.round(answerTime)}s)`;
            }
            
            // 更新本地学生数据中的答题时间
            if (classroomData.students[studentName]) {
                classroomData.students[studentName].last_answer_time = answerTime;
            }
            
            // 只更新表情，不重新创建整个卡片
            updateStudentExpression(studentName, 'submitted');
        } else {
            alert(data.message || 'Failed to submit answer');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error occurred while submitting answer');
    });
}

// 开始课堂
function startClass() {
    console.log('startClass函数被调用');
    
    // 检查是否有学生
    if (!classroomData.students || Object.keys(classroomData.students).length === 0) {
        alert('请先添加学生到课堂中！');
        return;
    }
    
    // 简单的UI更新测试
    const startBtn = document.getElementById('startBtn');
    const bingoBtn = document.getElementById('bingoBtn');
    const correctAnswerInput = document.getElementById('correctAnswerInput');
    
    console.log('找到的元素:', {
        startBtn: !!startBtn,
        bingoBtn: !!bingoBtn,
        correctAnswerInput: !!correctAnswerInput
    });
    
    if (startBtn) {
        startBtn.style.display = 'none';
        console.log('START按钮已隐藏');
    }
    
    if (bingoBtn) {
        bingoBtn.style.display = 'inline-block';
        console.log('BINGO按钮已显示');
    }
    
    if (correctAnswerInput) {
        correctAnswerInput.style.display = 'flex';
        console.log('正确答案输入框已显示');
    }
    
    // 禁用分数调整按钮
    const scoreMinusBtn = document.getElementById('scoreMinusBtn');
    const scorePlusBtn = document.getElementById('scorePlusBtn');
    if (scoreMinusBtn) scoreMinusBtn.disabled = true;
    if (scorePlusBtn) scorePlusBtn.disabled = true;
    
    // 发送请求 - 先创建课程，然后开始答题
    fetch('/api/start_course', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Class-ID': '{{ class_obj.id }}'
        },
        body: JSON.stringify({
            class_id: '{{ class_obj.id }}',
            course_name: '课堂 ' + new Date().toLocaleString('zh-CN')
        })
    })
    .then(response => {
        console.log('创建课程响应:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('创建课程数据:', data);
        if (data.success) {
            console.log('课程创建成功，现在开始答题');
            
            // 开始答题
            return fetch('/api/start_class', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Class-ID': '{{ class_obj.id }}'
                },
                body: JSON.stringify({
                    class_id: '{{ class_obj.id }}'
                })
            });
        } else {
            throw new Error(data.message || '创建课程失败');
        }
    })
    .then(response => {
        console.log('开始答题响应:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('开始答题数据:', data);
        if (data.success) {
            console.log('答题开始成功');
            // 简单的状态更新
            classroomData.round_active = true;
            classroomData.start_time = Date.now();
            startTime = Date.now();
            
            // 开始计时
            startTimer();
            console.log('计时器已启动');
            
            // 改变所有学生表情为专注状态
            setTimeout(() => {
                console.log('准备调用changeAllStudentsToFocused，当前classroomData:', classroomData);
                console.log('学生数据:', classroomData.students);
                changeAllStudentsToFocused();
                console.log('学生表情已更新为专注状态');
            }, 100);
        } else {
            throw new Error(data.message || '开始答题失败');
        }
    })
    .catch(error => {
        console.error('请求失败:', error);
        alert('开始课程失败: ' + error.message);
    });
}

// 开始计时
function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    
    timerInterval = setInterval(function() {
        if (startTime) {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }, 1000);
}

// 停止计时
function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

// 评判答案
    function judgeAnswers() {
        console.log('=== judgeAnswers函数开始执行 ===');
        
        try {
            const correctAnswer = document.getElementById('correctAnswerTextInput').value.trim();
            const questionScore = parseInt(document.getElementById('questionScore').textContent) || 1;
            
            console.log('正确答案:', correctAnswer);
            console.log('题目分数:', questionScore);
            
            if (!correctAnswer) {
                alert('Please enter correct answer');
                return;
            }
            
            // 立即隐藏BINGO按钮和输入框
            console.log('立即隐藏BINGO相关元素...');
            const bingoBtn = document.getElementById('bingoBtn');
            const correctAnswerInput = document.getElementById('correctAnswerInput');
            
            if (bingoBtn) {
                bingoBtn.style.display = 'none';
                bingoBtn.style.visibility = 'hidden';
                console.log('BINGO按钮已隐藏');
            } else {
                console.error('找不到BINGO按钮！');
            }
            
            if (correctAnswerInput) {
                correctAnswerInput.style.display = 'none';
                correctAnswerInput.style.visibility = 'hidden';
                console.log('输入框已隐藏');
            } else {
                console.error('找不到输入框！');
            }
            
            // 停止计时
            stopTimer();
            console.log('计时器已停止');
        
        fetch('/judge_answers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Class-ID': '{{ class_obj.id }}'
            },
            body: JSON.stringify({
                correct_answer: correctAnswer,
                question_score: questionScore
            })
        })
        .then(response => {
            console.log('收到评判响应:', response.status);
            return response.json();
        })
            .then(data => {
                console.log('评判数据:', data);
                if (data.success) {
                    console.log('评判成功');
                    console.log('评判前的轮次:', classroomData.current_round);
                    console.log('后端返回的学生数据:', data.students);
                    console.log('后端返回的轮次结果:', data.round_result);
                    
                    classroomData.students = data.students;
                    classroomData.round_active = false;
                    
                    // 不要更新当前轮次，评判完成后应该保持当前轮次不变
                    // 轮次只有在点击"Next Challenge"时才会改变
                    
                    console.log('更新后的学生数据:', classroomData.students);
                    console.log('评判后的轮次:', classroomData.current_round);
                    
                    // 更新学生显示和状态
                    updateStudentsDisplay(false);  // 不使用keepStates，强制更新
                    updateRoundStatus();
                    
                    // 显示答题结果 - 在updateStudentsDisplay之后调用
                    showAnswerResults(correctAnswer);
                    
                    // 显示正确答案
                    showCorrectAnswer(correctAnswer);
                    
                    // 确保BINGO按钮和输入框隐藏
                    console.log('后端响应后再次确保隐藏...');
                    const bingoBtn = document.getElementById('bingoBtn');
                    const correctAnswerInput = document.getElementById('correctAnswerInput');
                    
                    if (bingoBtn) {
                        bingoBtn.style.display = 'none';
                        bingoBtn.style.visibility = 'hidden';
                        console.log('后端响应后BINGO按钮已隐藏');
                    }
                    
                    if (correctAnswerInput) {
                        correctAnswerInput.style.display = 'none';
                        correctAnswerInput.style.visibility = 'hidden';
                        console.log('后端响应后输入框已隐藏');
                    }
                    
                    // 显示其他元素
                    const nextRoundBtn = document.getElementById('nextRoundBtn');
                    const progressStatsDisplay = document.getElementById('progressStatsDisplay');
                    
                    if (nextRoundBtn) {
                        nextRoundBtn.style.display = 'inline-block';
                        console.log('Next Challenge按钮已显示');
                    }
                    
                    if (progressStatsDisplay) {
                        progressStatsDisplay.style.display = 'flex';
                        console.log('进度统计已显示');
                    }
                
                // 更新UI - 隐藏输入框，显示结果
                setTimeout(() => {
                    console.log('开始执行UI更新...');
                    
                    const bingoBtn = document.getElementById('bingoBtn');
                    const nextRoundBtn = document.getElementById('nextRoundBtn');
                    const correctAnswerInput = document.getElementById('correctAnswerInput');
                    const progressStatsDisplay = document.getElementById('progressStatsDisplay');
                    
                    console.log('延迟UI元素检查:', {
                        bingoBtn: !!bingoBtn,
                        nextRoundBtn: !!nextRoundBtn,
                        correctAnswerInput: !!correctAnswerInput,
                        progressStatsDisplay: !!progressStatsDisplay
                    });
                    
                    // 强制隐藏BINGO按钮
                    if (bingoBtn) {
                        bingoBtn.style.display = 'none !important';
                        bingoBtn.style.visibility = 'hidden';
                        console.log('BINGO按钮已强制隐藏');
                    } else {
                        console.error('找不到BINGO按钮！');
                    }
                    
                    // 强制隐藏输入框
                    if (correctAnswerInput) {
                        correctAnswerInput.style.display = 'none !important';
                        correctAnswerInput.style.visibility = 'hidden';
                        console.log('正确答案输入框已强制隐藏');
                    } else {
                        console.error('找不到正确答案输入框！');
                    }
                    
                    // 显示Next Challenge按钮
                    if (nextRoundBtn) {
                        nextRoundBtn.style.display = 'inline-block';
                        nextRoundBtn.style.visibility = 'visible';
                        console.log('Next Challenge按钮已显示');
                    } else {
                        console.error('找不到Next Challenge按钮！');
                    }
                    
                    // 显示进度统计
                    if (progressStatsDisplay) {
                        progressStatsDisplay.style.display = 'flex';
                        progressStatsDisplay.style.visibility = 'visible';
                        console.log('进度统计已显示');
                    } else {
                        console.error('找不到progressStatsDisplay元素！');
                    }
                    
                    // 更新进度条
                    console.log('开始更新进度条...');
                    updateProgressBars();
                    
                    // 最后一次确保BINGO按钮隐藏
                    const finalBingoBtn = document.getElementById('bingoBtn');
                    const finalCorrectAnswerInput = document.getElementById('correctAnswerInput');
                    
                    if (finalBingoBtn) {
                        finalBingoBtn.style.display = 'none';
                        finalBingoBtn.style.visibility = 'hidden';
                        console.log('最终确认：BINGO按钮已隐藏');
                    }
                    
                    if (finalCorrectAnswerInput) {
                        finalCorrectAnswerInput.style.display = 'none';
                        finalCorrectAnswerInput.style.visibility = 'hidden';
                        console.log('最终确认：输入框已隐藏');
                    }
                    
                    console.log('UI更新完成！');
                }, 200);
                
                console.log('judgeAnswers执行完成');
            } else {
                console.error('评判失败:', data.message);
                alert(data.message || 'Failed to judge answers');
            }
        })
        .catch(error => {
            console.error('评判请求失败:', error);
            console.error('错误详情:', error.message);
            console.error('错误堆栈:', error.stack);
            
            // 不显示alert，只在控制台记录
            console.error('已捕获网络错误，不会显示弹窗');
        });
    } catch (error) {
        console.error('judgeAnswers函数内部错误:', error);
        console.error('错误详情:', error.message);
        console.error('错误堆栈:', error.stack);
        
        // 不显示alert，只在控制台记录
        console.error('已捕获错误，不会显示弹窗');
    }
}

// 显示答题结果
function showAnswerResults(correctAnswer) {
    console.log('showAnswerResults函数被调用，正确答案:', correctAnswer);
    console.log('当前学生数据:', classroomData.students);
    
    Object.values(classroomData.students).forEach(student => {
        // 过滤掉无效的学生数据
        if (!student || !student.name || student.name === 'undefined' || student.name === '') {
            console.warn('跳过无效学生数据:', student);
            return;
        }
        console.log(`处理学生 ${student.name}:`, student);
        console.log(`学生 ${student.name} 的expression:`, student.expression);
        console.log(`学生 ${student.name} 的score:`, student.score);
        console.log(`学生 ${student.name} 的total_rounds:`, student.total_rounds);
        console.log(`学生 ${student.name} 的last_answer:`, student.last_answer);
        
        const resultDiv = document.getElementById(`result-${student.name}`);
        const resultText = resultDiv ? resultDiv.querySelector('.result-text') : null;
        console.log(`学生 ${student.name} 的resultDiv:`, resultDiv);
        console.log(`学生 ${student.name} 的resultText:`, resultText);
        const inputGroup = document.getElementById(`input-group-${student.name}`);
        const submittedDiv = document.getElementById(`submitted-${student.name}`);
        
        if (resultDiv && resultText) {
            // 隐藏输入框和提交状态
            if (inputGroup) {
                inputGroup.style.display = 'none';
            }
            if (submittedDiv) {
                submittedDiv.style.display = 'none';
            }
            
            // 显示四个指标
            const statsDiv = document.getElementById(`stats-${student.name}`);
            console.log(`学生 ${student.name} 的统计数据元素:`, statsDiv);
            console.log(`学生 ${student.name} 的DOM结构:`, document.querySelector(`[data-student="${student.name}"]`));
            
            if (statsDiv) {
                console.log(`学生 ${student.name} 的stats元素存在，当前display:`, statsDiv.style.display);
                statsDiv.style.display = 'block';
                console.log(`学生 ${student.name} 的统计数据已显示，新display:`, statsDiv.style.display);
                
                // 更新统计数据内容
                const scoreElement = statsDiv.querySelector('.stat-item:nth-child(1) .stat-value');
                const roundsElement = statsDiv.querySelector('.stat-item:nth-child(2) .stat-value');
                const accElement = statsDiv.querySelector('.stat-item:nth-child(3) .stat-value');
                const timeElement = statsDiv.querySelector('.stat-item:nth-child(4) .stat-value');
                
                console.log(`学生 ${student.name} 的统计元素:`, {
                    scoreElement, roundsElement, accElement, timeElement
                });
                
                if (scoreElement) {
                    scoreElement.textContent = student.score;
                    console.log(`学生 ${student.name} Score更新为:`, student.score);
                }
                if (roundsElement) {
                    roundsElement.textContent = student.total_rounds || 0;
                    console.log(`学生 ${student.name} Rounds更新为:`, student.total_rounds || 0);
                }
                if (accElement) {
                    const accValue = student.total_rounds ? Math.round((student.correct_rounds || 0) / student.total_rounds * 100) : 0;
                    accElement.textContent = accValue + '%';
                    console.log(`学生 ${student.name} Acc更新为:`, accValue + '%');
                }
                if (timeElement) {
                    timeElement.textContent = student.last_answer || '-';
                    console.log(`学生 ${student.name} Answer更新为:`, student.last_answer || '-');
                }
            } else {
                console.error(`找不到学生 ${student.name} 的统计数据元素`);
                console.log(`尝试查找学生 ${student.name} 的卡片:`, document.querySelector(`[data-student="${student.name}"]`));
            }
            
            // 显示答题结果
            resultDiv.style.display = 'block';
            
            if (student.expression === 'smile') {
                resultText.innerHTML = '<span class="result-icon">✓</span><span class="result-label">Correct</span>';
                resultText.className = 'result-text correct-result';
                
                // 添加跳动效果到学生卡片
                const studentCard = document.querySelector(`[data-student="${student.name}"]`);
                if (studentCard) {
                    studentCard.classList.add('correct-bounce-animation');
                }
            } else if (student.expression === 'angry') {
                resultText.innerHTML = '<span class="result-icon">✗</span><span class="result-label">Wrong</span>';
                resultText.className = 'result-text wrong-result';
            } else if (student.expression === 'embarrassed') {
                resultText.innerHTML = '<span class="result-icon">○</span><span class="result-label">No Answer</span>';
                resultText.className = 'result-text no-answer-result';
            }
        }
    });
}

// 显示正确答案
function showCorrectAnswer(correctAnswer) {
    try {
        const correctAnswerDisplay = document.getElementById('correctAnswerDisplay');
        const correctAnswerValue = document.getElementById('correctAnswerValue');
        
        console.log('showCorrectAnswer元素检查:', {
            correctAnswerDisplay: !!correctAnswerDisplay,
            correctAnswerValue: !!correctAnswerValue
        });
        
        if (correctAnswerDisplay && correctAnswerValue) {
            correctAnswerValue.textContent = correctAnswer;
            correctAnswerDisplay.style.display = 'block';
            
            // 添加显示动画
            correctAnswerDisplay.style.animation = 'slideInDown 0.6s ease-out';
            console.log('正确答案显示已更新');
        } else {
            console.error('正确答案显示元素未找到！', {correctAnswerDisplay, correctAnswerValue});
        }
    } catch (error) {
        console.error('showCorrectAnswer函数内部错误:', error);
        console.error('已捕获错误，不会显示弹窗');
    }
}

// 更新进度条
function updateProgressBars() {
    try {
        console.log('updateProgressBars函数被调用');
        
        const students = Object.values(classroomData.students);
        const totalStudents = students.length;
        
        console.log('学生数据:', students);
        console.log('总学生数:', totalStudents);
        
        // 计算参与人数（当前轮次有提交答案的学生）
        const participatedStudents = students.filter(student => 
            student.expression === 'smile' || student.expression === 'angry' || student.expression === 'submitted'
        );
        const participationRate = totalStudents > 0 ? (participatedStudents.length / totalStudents) * 100 : 0;
        
        console.log('参与学生:', participatedStudents.map(s => s.name));
        console.log('未参与学生:', students.filter(s => !participatedStudents.includes(s)).map(s => s.name));
        
        // 计算正确率（参与学生中答对的比例）
        const correctStudents = students.filter(student => student.expression === 'smile');
        const accuracyRate = participatedStudents.length > 0 ? (correctStudents.length / participatedStudents.length) * 100 : 0;
        
        // 计算平均答题时间 - 计算所有参与学生的平均时间
        const avgTime = participatedStudents.length > 0 ? 
            participatedStudents.reduce((sum, student) => sum + (student.last_answer_time || 0), 0) / participatedStudents.length : 0;
        
        console.log('参与率:', participationRate);
        console.log('正确率:', accuracyRate);
        console.log('平均时间:', avgTime);
        console.log('参与学生的时间详情:', participatedStudents.map(s => ({name: s.name, time: s.last_answer_time, expression: s.expression})));
        
        // 更新参与度进度条
        try {
            const participationBar = document.getElementById('participationBar');
            const participationPercentage = document.getElementById('participationPercentage');
            console.log('参与度元素:', {participationBar: !!participationBar, participationPercentage: !!participationPercentage});
            if (participationBar && participationPercentage) {
                participationBar.style.width = participationRate + '%';
                participationPercentage.textContent = Math.round(participationRate) + '%';
                console.log('参与度进度条已更新，宽度:', participationRate + '%');
            } else {
                console.error('参与度进度条元素未找到！', {participationBar, participationPercentage});
            }
        } catch (e) {
            console.error('参与度进度条更新失败:', e);
        }
        
        // 更新正确率进度条
        try {
            const accuracyBar = document.getElementById('accuracyBar');
            const accuracyPercentage = document.getElementById('accuracyPercentage');
            console.log('正确率元素:', {accuracyBar: !!accuracyBar, accuracyPercentage: !!accuracyPercentage});
            if (accuracyBar && accuracyPercentage) {
                accuracyBar.style.width = accuracyRate + '%';
                accuracyPercentage.textContent = Math.round(accuracyRate) + '%';
                console.log('正确率进度条已更新');
            } else {
                console.error('正确率进度条元素未找到！', {accuracyBar, accuracyPercentage});
            }
        } catch (e) {
            console.error('正确率进度条更新失败:', e);
        }
        
        // 更新时间进度条
        try {
            const timeBar = document.getElementById('timeBar');
            const timePercentage = document.getElementById('timePercentage');
            console.log('时间元素:', {timeBar: !!timeBar, timePercentage: !!timePercentage});
            if (timeBar && timePercentage) {
                // 时间进度条显示平均时间，最大显示30秒
                const timeRate = Math.min(avgTime / 30, 1) * 100;
                timeBar.style.width = timeRate + '%';
                timePercentage.textContent = Math.round(avgTime) + 's';
                console.log('时间进度条已更新');
            } else {
                console.error('时间进度条元素未找到！', {timeBar, timePercentage});
            }
        } catch (e) {
            console.error('时间进度条更新失败:', e);
        }
        
        console.log('updateProgressBars执行完成');
    } catch (error) {
        console.error('updateProgressBars函数内部错误:', error);
        console.error('已捕获错误，不会显示弹窗');
    }
}

// 改变所有学生表情为专注状态
function changeAllStudentsToFocused() {
    console.log('Changing all students to focused state...');
    console.log('当前学生数据:', classroomData.students);
    
    // 检查学生数据是否存在
    if (!classroomData.students || Object.keys(classroomData.students).length === 0) {
        console.warn('没有学生数据，无法更新表情');
        return;
    }
    
    Object.values(classroomData.students).forEach(student => {
        console.log(`Updating student ${student.name} to focused`);
        // 更新学生数据中的表情
        student.expression = 'focused';
        
        // 更新页面上的表情显示
        updateStudentExpression(student.name, 'focused');
    });
    
    console.log('所有学生表情更新完成');
}

// 下一轮
function nextRound() {
    fetch('/next_round', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Class-ID': '{{ class_obj.id }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            classroomData.students = data.students;
            classroomData.current_round = data.round;
            classroomData.round_active = false;
            
            // 更新轮次显示
            updateRoundStatus();
            
            // 重置UI - 添加安全检查
            const nextRoundBtn = document.getElementById('nextRoundBtn');
            const startBtn = document.getElementById('startBtn');
            const bingoBtn = document.getElementById('bingoBtn');
            const correctAnswerInput = document.getElementById('correctAnswerInput');
            const correctAnswerTextInput = document.getElementById('correctAnswerTextInput');
            const correctAnswerDisplay = document.getElementById('correctAnswerDisplay');
            const progressStatsDisplay = document.getElementById('progressStatsDisplay');
            const timerDisplay = document.getElementById('timerDisplay');
            
            if (nextRoundBtn) nextRoundBtn.style.display = 'none';
            if (startBtn) startBtn.style.display = 'inline-block';
            if (bingoBtn) {
                bingoBtn.style.display = 'none';
                bingoBtn.style.visibility = 'visible';
            }
            if (correctAnswerInput) {
                correctAnswerInput.style.display = 'none';
                correctAnswerInput.style.visibility = 'visible';
            }
            if (correctAnswerTextInput) correctAnswerTextInput.value = '';
            if (correctAnswerDisplay) correctAnswerDisplay.style.display = 'none';
            if (progressStatsDisplay) progressStatsDisplay.style.display = 'none';
            if (timerDisplay) timerDisplay.textContent = '00:00';
            
            // 更新按钮文本
            if (startBtn) startBtn.innerHTML = '<i class="fas fa-play me-2"></i>START!';
            
            // 重新启用分数调整按钮
            const scoreMinusBtn = document.getElementById('scoreMinusBtn');
            const scorePlusBtn = document.getElementById('scorePlusBtn');
            if (scoreMinusBtn) scoreMinusBtn.disabled = false;
            if (scorePlusBtn) scorePlusBtn.disabled = false;
            
            // 隐藏进度统计（条形图）
            if (progressStatsDisplay) progressStatsDisplay.style.display = 'none';
            
            // 重置所有学生的提交状态和表情
            Object.values(classroomData.students).forEach(student => {
                // 过滤掉无效的学生数据
                if (!student || !student.name || student.name === 'undefined' || student.name === '') {
                    console.warn('跳过无效学生数据:', student);
                    return;
                }
                // 重置学生表情为正常状态
                student.expression = 'neutral';
                student.animation = 'none';
                
                // 移除跳动效果
                const studentCard = document.querySelector(`[data-student="${student.name}"]`);
                if (studentCard) {
                    studentCard.classList.remove('correct-bounce-animation');
                }
                
                // 重置输入栏显示
                const inputGroup = document.getElementById(`input-group-${student.name}`);
                const submittedDiv = document.getElementById(`submitted-${student.name}`);
                const resultDiv = document.getElementById(`result-${student.name}`);
                const statsDiv = document.getElementById(`stats-${student.name}`);
                const answerInput = document.querySelector(`[data-student="${student.name}"].student-answer-input`);
                
                if (inputGroup) {
                    inputGroup.style.display = 'flex';
                }
                if (submittedDiv) {
                    submittedDiv.style.display = 'none';
                }
                if (resultDiv) {
                    resultDiv.style.display = 'none';
                }
                if (statsDiv) {
                    statsDiv.style.display = 'none';
                }
                // 清空输入框
                if (answerInput) {
                    answerInput.value = '';
                }
            });
            
            updateStudentsDisplay(true);  // 保持服务器返回的状态
            
            // 确保所有学生表情都重置为neutral
            setTimeout(() => {
                Object.values(classroomData.students).forEach(student => {
                    // 过滤掉无效的学生数据
                    if (!student || !student.name || student.name === 'undefined' || student.name === '') {
                        return;
                    }
                    updateStudentExpression(student.name, 'neutral');
                });
            }, 100);
            updateRoundStatus();
        }
    })
    .catch(error => {
        console.error('Next round error:', error);
        console.log('Error details:', error.message);
        // 不显示弹窗，只记录错误
    });
}

// 更新轮次状态
function updateRoundStatus() {
    try {
        const roundNumber = document.getElementById('roundNumber');
        
        console.log('updateRoundStatus - 当前轮次:', classroomData.current_round);
        
        if (roundNumber) {
            console.log('updateRoundStatus - 更新轮次显示为:', classroomData.current_round);
            roundNumber.textContent = classroomData.current_round;
        }
        
        // 不要重新显示BINGO按钮，保持当前状态
        console.log('updateRoundStatus执行完成，不改变BINGO按钮状态');
    } catch (error) {
        console.error('updateRoundStatus错误:', error);
    }
}

// 重置课堂
function resetClassroom() {
    if (confirm('Are you sure you want to reset the classroom? This will clear all data.')) {
        fetch('/reset_classroom', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 重新加载页面
                location.reload();
            } else {
                alert(data.message || 'Failed to reset classroom');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error occurred while resetting classroom');
        });
    }
}

// 调整分数
function changeScore(delta) {
    const scoreElement = document.getElementById('questionScore');
    let currentScore = parseInt(scoreElement.textContent) || 1;
    let newScore = currentScore + delta;
    
    // 限制分数范围在1-10之间
    if (newScore < 1) newScore = 1;
    if (newScore > 10) newScore = 10;
    
    scoreElement.textContent = newScore;
}

// 课堂结束
function endClass() {
    if (confirm('确定要结束课堂吗？将进入颁奖典礼！')) {
        // 跳转到颁奖典礼页面
        window.location.href = '/ceremony/{{ class_obj.id }}';
    }
}
</script>
{% endblock %}