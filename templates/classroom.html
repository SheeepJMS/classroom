{% extends "base.html" %}

{% block title %}Classroom Management System{% endblock %}

{% block content %}
<div class="classroom-container">
    <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
    <div class="top-control-bar">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <div class="round-status">
                        <div class="status-item">
                            <span class="status-label">Round</span>
                            <span class="status-value" id="roundNumber">{{ classroom_data.current_round }}</span>
                        </div>
                        <div class="status-text" id="roundStatus">Ready to start</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="score-display">
                        <span class="score-label">SCORE</span>
                        <div class="score-control">
                            <button class="btn btn-sm btn-outline-light" id="scoreMinusBtn" onclick="changeScore(-1)">-</button>
                            <span class="score-value" id="questionScore">1</span>
                            <button class="btn btn-sm btn-outline-light" id="scorePlusBtn" onclick="changeScore(1)">+</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="answer-input-group">
                        <input type="text" id="correctAnswerInput" class="form-control" placeholder="Enter correct answer..." style="display: none;">
                    </div>
                </div>
                <div class="col-md-2 text-center">
                    <button id="startBtn" class="btn btn-success btn-lg">
                        <i class="fas fa-play me-2"></i>START!
                    </button>
                    <button id="bingoBtn" class="btn btn-warning btn-lg" style="display: none;">
                        <i class="fas fa-star me-2"></i>BINGO!
                    </button>
                    <button id="nextRoundBtn" class="btn btn-info btn-lg" style="display: none;">
                        <i class="fas fa-forward me-2"></i>Next Challenge
                    </button>
                </div>
                <div class="col-md-2">
                    <div class="timer-display text-end">
                        <i class="fas fa-clock me-2"></i>
                        <span id="timerDisplay">00:00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å³ä¸‹è§’éšè—æŒ‰é’® -->
    <div class="hidden-controls">
        <button id="resetBtn" class="btn btn-danger btn-sm">
            <i class="fas fa-refresh"></i>
        </button>
        <a href="/reports" class="btn btn-primary btn-sm">
            <i class="fas fa-chart-bar"></i>
        </a>
    </div>

    <!-- å­¦ç”Ÿç®¡ç†åŒºåŸŸ -->
    <div class="students-management-area">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="students-header">
                        <div class="header-left">
                            <i class="fas fa-users me-2"></i>
                            <span>Student Management</span>
                        </div>
                        <div class="header-right">
                            <span>Students: <span id="studentCount">{{ classroom_data.students|length }}</span></span>
                        </div>
                    </div>
                    
                    <div class="students-grid" id="studentsGrid">
                        <!-- å­¦ç”Ÿå¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å­¦ç”ŸåŒºåŸŸ -->
    <div class="add-student-area">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="add-student-form">
                        <input type="text" id="studentNameInput" class="form-control" placeholder="Enter student name">
                        <button id="addStudentBtn" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>+ Add Student
                        </button>
                    </div>
                    <div class="quick-tip">Press Enter to add quickly</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let classroomData = {{ classroom_data | tojson | safe }};
let timerInterval = null;
let startTime = null;

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // å¼ºåˆ¶åˆ·æ–°å­¦ç”Ÿæ•°æ®
    fetch('/get_classroom_data')
        .then(response => response.json())
        .then(data => {
            classroomData = data;
            
            // é‡ç½®å½“å‰è½®æ¬¡çš„ç­”é¢˜çŠ¶æ€ï¼ˆä¿ç•™æ•°æ®å’Œå›åˆæ•°ï¼‰
            classroomData.round_active = false;
            classroomData.current_answers = {};
            classroomData.answer_times = {};
            classroomData.start_time = null;
            
            updateStudentsDisplay();
            updateRoundStatus();
        })
        .catch(error => {
            console.error('Error loading classroom data:', error);
            updateStudentsDisplay();
            updateRoundStatus();
        });
    
    // ç»‘å®šäº‹ä»¶
    document.getElementById('startBtn').addEventListener('click', startClass);
    document.getElementById('bingoBtn').addEventListener('click', judgeAnswers);
    document.getElementById('nextRoundBtn').addEventListener('click', nextRound);
    document.getElementById('resetBtn').addEventListener('click', resetClassroom);
    document.getElementById('addStudentBtn').addEventListener('click', addStudent);
    document.getElementById('studentNameInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            addStudent();
        }
    });
});

// å­¦ç”Ÿç®¡ç†åŠŸèƒ½
function addStudent() {
    const studentName = document.getElementById('studentNameInput').value.trim();
    if (!studentName) {
        alert('Please enter student name');
        return;
    }
    
    fetch('/add_student', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            student_name: studentName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            classroomData.students[studentName] = data.student;
            updateStudentsDisplay();
            document.getElementById('studentNameInput').value = '';
            document.getElementById('studentCount').textContent = Object.keys(classroomData.students).length;
        } else {
            alert(data.message || 'Failed to add student');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error occurred while adding student');
    });
}

// é‡ç½®å­¦ç”Ÿç­”é¢˜çŠ¶æ€ï¼ˆä¿ç•™æ•°æ®å’Œå›åˆæ•°ï¼‰
function resetStudentAnswerStates() {
    Object.values(classroomData.students).forEach(student => {
        // é‡ç½®è¡¨æƒ…å’ŒåŠ¨ç”»ï¼Œä½†ä¿ç•™å…¶ä»–æ•°æ®
        student.expression = 'neutral';
        student.animation = 'none';
    });
}

// æ›´æ–°å•ä¸ªå­¦ç”Ÿçš„è¡¨æƒ…å’ŒçŠ¶æ€ï¼ˆä¸é‡æ–°åˆ›å»ºå¡ç‰‡ï¼‰
function updateStudentExpression(studentName, expression) {
    const studentCard = document.querySelector(`[data-student="${studentName}"]`);
    if (studentCard) {
        const emojiElement = studentCard.querySelector('.student-emoji');
        if (emojiElement) {
            let emoji = 'ğŸ˜';  // é»˜è®¤é¢æ— è¡¨æƒ…
            if (expression === 'smile') {
                emoji = 'ğŸ˜Š';
            } else if (expression === 'angry') {
                emoji = 'ğŸ˜¢';
            } else if (expression === 'embarrassed') {
                emoji = 'ğŸ˜…';
            } else if (expression === 'neutral') {
                emoji = 'ğŸ˜';
            } else if (expression === 'submitted') {
                emoji = 'ğŸ˜œ';  // å¤çµç²¾æ€ªåèˆŒå¤´æ‰®é¬¼è„¸
            }
            emojiElement.textContent = emoji;
        }
        
        // æ›´æ–°CSSç±»
        studentCard.className = 'student-card';
        if (expression === 'smile') {
            studentCard.classList.add('correct-answer');
        } else if (expression === 'angry') {
            studentCard.classList.add('wrong-answer');
        } else if (expression === 'embarrassed') {
            studentCard.classList.add('no-answer');
        }
    }
}

// æ›´æ–°å­¦ç”Ÿæ˜¾ç¤ºï¼ˆä¸é‡ç½®çŠ¶æ€ï¼‰
function updateStudentsDisplay(keepStates = false) {
    const studentsGrid = document.getElementById('studentsGrid');
    studentsGrid.innerHTML = '';
    
    // åªæœ‰åœ¨é¡µé¢åˆå§‹åŒ–æ—¶æ‰é‡ç½®çŠ¶æ€
    if (!keepStates) {
        resetStudentAnswerStates();
    }
    
    Object.values(classroomData.students).forEach(student => {
        const studentCard = createStudentCard(student);
        studentsGrid.appendChild(studentCard);
    });
}

// åˆ›å»ºå­¦ç”Ÿå¡ç‰‡
function createStudentCard(student) {
    const card = document.createElement('div');
    
    // æ ¹æ®å­¦ç”ŸçŠ¶æ€æ·»åŠ CSSç±»
    let cardClass = 'student-card';
    if (student.expression === 'smile') {
        cardClass += ' correct-answer';
    } else if (student.expression === 'angry') {
        cardClass += ' wrong-answer';
    } else if (student.expression === 'embarrassed') {
        cardClass += ' no-answer';
    }
    
    // æ ¹æ®è¡¨æƒ…é€‰æ‹©emoji
    let emoji = 'ğŸ˜';  // é»˜è®¤é¢æ— è¡¨æƒ…
    if (student.expression === 'smile') {
        emoji = 'ğŸ˜Š';
    } else if (student.expression === 'angry') {
        emoji = 'ğŸ˜¢';
    } else if (student.expression === 'embarrassed') {
        emoji = 'ğŸ˜…';
    } else if (student.expression === 'neutral') {
        emoji = 'ğŸ˜';  // é¢æ— è¡¨æƒ…
    } else if (student.expression === 'submitted') {
        emoji = 'ğŸ˜œ';  // å¤çµç²¾æ€ªåèˆŒå¤´æ‰®é¬¼è„¸
    }
    
    // æ ¹æ®åŠ¨ç”»çŠ¶æ€æ·»åŠ åŠ¨ç”»ç±» - åªæœ‰ç­”å¯¹çš„å­¦ç”Ÿæ‰æ™ƒåŠ¨
    let animationClass = '';
    if (student.expression === 'smile' && student.animation === 'celebration') {
        animationClass = ' correct-bounce-animation';
    }
    
    card.className = cardClass + animationClass;
    card.setAttribute('data-student', student.name);
    card.innerHTML = `
        <div class="student-avatar" style="background-color: ${student.avatar_color}">
            <span class="student-emoji">${emoji}</span>
        </div>
        <div class="student-name">${student.name}</div>
        <div class="student-input-group" id="input-group-${student.name}">
            <input type="text" class="form-control student-answer-input" placeholder="Answer" data-student="${student.name}">
            <button class="btn btn-sm btn-outline-primary submit-btn" data-student="${student.name}">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
                <div class="student-submitted" id="submitted-${student.name}" style="display: none;">
                    <span class="submitted-text">Submitted</span>
                </div>
                <div class="student-result" id="result-${student.name}" style="display: none;">
                    <span class="result-text"></span>
                </div>
        <div class="student-stats">
            <div class="stat-item">
                <span class="stat-label">Score</span>
                <span class="stat-value">${student.score}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Rounds</span>
                <span class="stat-value">${student.total_rounds || 0}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Acc</span>
                <span class="stat-value">${student.total_rounds ? Math.round((student.correct_rounds || 0) / student.total_rounds * 100) : 0}%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Last</span>
                <span class="stat-value">${Math.round(student.last_answer_time || 0)}s</span>
            </div>
        </div>
        <div class="student-status" id="status-${student.name}"></div>
    `;
    
    // ç»‘å®šæäº¤æŒ‰é’®äº‹ä»¶
    const submitBtn = card.querySelector('.submit-btn');
    const answerInput = card.querySelector('.student-answer-input');
    
    submitBtn.addEventListener('click', function() {
        submitStudentAnswer(student.name, answerInput.value);
    });
    
    answerInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            submitStudentAnswer(student.name, answerInput.value);
        }
    });
    
    return card;
}

// æäº¤å­¦ç”Ÿç­”æ¡ˆ
function submitStudentAnswer(studentName, answer) {
    if (!answer.trim()) {
        alert('Please enter an answer');
        return;
    }
    
    fetch('/submit_student_answer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            student_name: studentName,
            answer: answer
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ›´æ–°å­¦ç”Ÿè¡¨æƒ…ä¸ºsubmitted
            if (classroomData.students[studentName]) {
                classroomData.students[studentName].expression = 'submitted';
            }
            
            // éšè—è¾“å…¥æ å’ŒæŒ‰é’®ï¼Œæ˜¾ç¤ºSubmitted
            const inputGroup = document.getElementById(`input-group-${studentName}`);
            const submittedDiv = document.getElementById(`submitted-${studentName}`);
            
            if (inputGroup) {
                inputGroup.style.display = 'none';
            }
            if (submittedDiv) {
                submittedDiv.style.display = 'block';
            }
            
            // åªæ›´æ–°è¡¨æƒ…ï¼Œä¸é‡æ–°åˆ›å»ºæ•´ä¸ªå¡ç‰‡
            updateStudentExpression(studentName, 'submitted');
        } else {
            alert(data.message || 'Failed to submit answer');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error occurred while submitting answer');
    });
}

// å¼€å§‹è¯¾å ‚
function startClass() {
    fetch('/start_class', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            classroomData.round_active = true;
            classroomData.start_time = Date.now();
            startTime = Date.now();
            
            // å¼€å§‹è®¡æ—¶
            startTimer();
            
            // æ›´æ–°UI
            updateRoundStatus();
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('bingoBtn').style.display = 'inline-block';
            document.getElementById('correctAnswerInput').style.display = 'block';
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬ä¸ºä¸‹ä¸€è½®
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play me-2"></i>START!';
            
            // ç¦ç”¨åˆ†æ•°è°ƒæ•´æŒ‰é’®
            document.getElementById('scoreMinusBtn').disabled = true;
            document.getElementById('scorePlusBtn').disabled = true;
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// å¼€å§‹è®¡æ—¶
function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    
    timerInterval = setInterval(function() {
        if (startTime) {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }, 1000);
}

// åœæ­¢è®¡æ—¶
function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

// è¯„åˆ¤ç­”æ¡ˆ
function judgeAnswers() {
    const correctAnswer = document.getElementById('correctAnswerInput').value.trim();
    const questionScore = parseInt(document.getElementById('questionScore').textContent) || 1;
    
    if (!correctAnswer) {
        alert('Please enter correct answer');
        return;
    }
    
    // åœæ­¢è®¡æ—¶
    stopTimer();
    
    fetch('/judge_answers', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            correct_answer: correctAnswer,
            question_score: questionScore
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            classroomData.students = data.students;
            classroomData.round_active = false;
            
            // æ˜¾ç¤ºç­”é¢˜ç»“æœ
            showAnswerResults(correctAnswer);
            
            updateStudentsDisplay(true);  // ä¿æŒæœåŠ¡å™¨è¿”å›çš„çŠ¶æ€
            updateRoundStatus();
            
            // æ›´æ–°UI
            document.getElementById('bingoBtn').style.display = 'none';
            document.getElementById('nextRoundBtn').style.display = 'inline-block';
            document.getElementById('correctAnswerInput').style.display = 'none';
        } else {
            alert(data.message || 'Failed to judge answers');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error occurred while judging answers');
    });
}

// æ˜¾ç¤ºç­”é¢˜ç»“æœ
function showAnswerResults(correctAnswer) {
    Object.values(classroomData.students).forEach(student => {
        const resultDiv = document.getElementById(`result-${student.name}`);
        const resultText = resultDiv.querySelector('.result-text');
        
        if (resultDiv && resultText) {
            resultDiv.style.display = 'block';
            
            if (student.expression === 'smile') {
                resultText.textContent = 'Correct âœ“';
                resultText.className = 'result-text correct-result';
            } else if (student.expression === 'angry') {
                resultText.textContent = 'Wrong âœ—';
                resultText.className = 'result-text wrong-result';
            } else if (student.expression === 'embarrassed') {
                resultText.textContent = 'No Answer';
                resultText.className = 'result-text no-answer-result';
            }
        }
    });
}

// ä¸‹ä¸€è½®
function nextRound() {
    fetch('/next_round', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            classroomData.students = data.students;
            classroomData.current_round = data.round;
            classroomData.round_active = false;
            
            // é‡ç½®UI
            document.getElementById('nextRoundBtn').style.display = 'none';
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('correctAnswerInput').style.display = 'none';
            document.getElementById('correctAnswerInput').value = '';
            document.getElementById('timerDisplay').textContent = '00:00';
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play me-2"></i>START!';
            
            // é‡æ–°å¯ç”¨åˆ†æ•°è°ƒæ•´æŒ‰é’®
            document.getElementById('scoreMinusBtn').disabled = false;
            document.getElementById('scorePlusBtn').disabled = false;
            
            // é‡ç½®æ‰€æœ‰å­¦ç”Ÿçš„æäº¤çŠ¶æ€å’Œè¡¨æƒ…
            Object.values(classroomData.students).forEach(student => {
                // é‡ç½®å­¦ç”Ÿè¡¨æƒ…ä¸ºæ­£å¸¸çŠ¶æ€
                student.expression = 'neutral';
                student.animation = 'none';
                
                // é‡ç½®è¾“å…¥æ æ˜¾ç¤º
                const inputGroup = document.getElementById(`input-group-${student.name}`);
                const submittedDiv = document.getElementById(`submitted-${student.name}`);
                const resultDiv = document.getElementById(`result-${student.name}`);
                
                if (inputGroup) {
                    inputGroup.style.display = 'flex';
                }
                if (submittedDiv) {
                    submittedDiv.style.display = 'none';
                }
                if (resultDiv) {
                    resultDiv.style.display = 'none';
                }
            });
            
            updateStudentsDisplay(true);  // ä¿æŒæœåŠ¡å™¨è¿”å›çš„çŠ¶æ€
            updateRoundStatus();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error occurred while starting next round');
    });
}

// æ›´æ–°è½®æ¬¡çŠ¶æ€
function updateRoundStatus() {
    const roundStatus = document.getElementById('roundStatus');
    const roundNumber = document.getElementById('roundNumber');
    
    roundNumber.textContent = classroomData.current_round;
    
    if (classroomData.round_active) {
        roundStatus.textContent = 'In Progress';
    } else {
        // æ£€æŸ¥æ˜¯å¦æœ‰ç­”é¢˜ç»“æœ
        const hasResults = Object.values(classroomData.students).some(student => 
            student.expression === 'smile' || student.expression === 'angry' || student.expression === 'embarrassed'
        );
        
        if (hasResults) {
            roundStatus.textContent = 'Ready for next round';
        } else {
            roundStatus.textContent = 'Ready to start';
        }
    }
}

// é‡ç½®è¯¾å ‚
function resetClassroom() {
    if (confirm('Are you sure you want to reset the classroom? This will clear all data.')) {
        fetch('/reset_classroom', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // é‡æ–°åŠ è½½é¡µé¢
                location.reload();
            } else {
                alert(data.message || 'Failed to reset classroom');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error occurred while resetting classroom');
        });
    }
}

// è°ƒæ•´åˆ†æ•°
function changeScore(delta) {
    const scoreElement = document.getElementById('questionScore');
    let currentScore = parseInt(scoreElement.textContent) || 1;
    let newScore = currentScore + delta;
    
    // é™åˆ¶åˆ†æ•°èŒƒå›´åœ¨1-10ä¹‹é—´
    if (newScore < 1) newScore = 1;
    if (newScore > 10) newScore = 10;
    
    scoreElement.textContent = newScore;
}
</script>
{% endblock %}