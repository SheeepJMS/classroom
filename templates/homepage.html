{% extends "base.html" %}

{% block title %}烧脑数学课堂管理系统{% endblock %}

{% block content %}
<style>

/* 主导航栏样式 */
.main-nav {
    background: #3498db;
    color: white;
    padding: 15px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.main-nav .container {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nav-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0;
}



/* 仪表盘样式 */
.dashboard-section {
    background: white;
    margin: 20px 0;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.dashboard-title {
    font-size: 20px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 15px;
    border-bottom: 2px solid #ecf0f1;
    padding-bottom: 10px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.stat-card {
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    text-align: center;
    transition: transform 0.3s, box-shadow 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.stat-card.blue {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
}

.stat-card.blue * {
    color: white !important;
}

.stat-card.green {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    color: white;
}

.stat-card.green * {
    color: white !important;
}

.stat-card.cyan {
    background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
    color: white;
}

.stat-card.cyan * {
    color: white !important;
}


.stat-icon {
    font-size: 20px;
    margin-bottom: 5px;
    opacity: 0.9;
}

.stat-number {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 3px;
}

.stat-label {
    font-size: 10px;
    opacity: 0.9;
}

/* 活动记录样式 */
.activity-section {
    background: white;
    margin: 20px 0;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.activity-title {
    font-size: 20px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 15px;
    border-bottom: 2px solid #ecf0f1;
    padding-bottom: 10px;
}

.activity-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

.activity-table th,
.activity-table td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid #ecf0f1;
}

.activity-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #2c3e50;
}

.activity-table tr:hover {
    background: #f8f9fa;
}

.student-link {
    color: #3498db;
    text-decoration: none;
}

.student-link:hover {
    text-decoration: underline;
}

.progress-bar {
    width: 100px;
    height: 8px;
    background: #ecf0f1;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s;
}

.progress-fill.green { background: #27ae60; }
.progress-fill.yellow { background: #f39c12; }
.progress-fill.red { background: #e74c3c; }

/* 最近课程活动样式 */

.recent-courses-container {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding-bottom: 10px;
}

.course-card {
    background: white;
    border: 1px solid #ecf0f1;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.3s, box-shadow 0.3s;
    min-width: 200px;
    flex-shrink: 0;
    position: relative;
    display: flex;
    flex-direction: column;
}

.course-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.course-number {
    font-size: 18px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
}

.course-class {
    font-size: 14px;
    color: #3498db;
    margin-bottom: 5px;
}

.course-date {
    font-size: 12px;
    color: #7f8c8d;
    margin-bottom: 10px;
}

.course-status-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #27ae60;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
}

.course-progress {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}

.course-progress .progress-bar {
    flex: 1;
    height: 6px;
}

.progress-text {
    font-size: 12px;
    color: #7f8c8d;
}

.view-course-report-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: background-color 0.3s;
    margin-top: 10px;
    align-self: flex-start;
}

.view-course-report-btn:hover {
    background: #2980b9;
}

.empty-courses {
    text-align: center;
    padding: 40px 20px;
    color: #7f8c8d;
    width: 100%;
}

.empty-courses i {
    color: #bdc3c7;
    margin-bottom: 15px;
}

.empty-courses h4 {
    color: #2c3e50;
    margin-bottom: 10px;
}

/* 班级管理区域 */
.classes-section {
    background: white;
    margin: 20px 0;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    border-bottom: 2px solid #ecf0f1;
    padding-bottom: 15px;
}

.section-title {
    font-size: 24px;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
}

.create-btn {
    background: #27ae60;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.create-btn:hover {
    background: #229954;
}

.classes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.class-card {
    background: white;
    border: 1px solid #ecf0f1;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.3s, box-shadow 0.3s;
}

.class-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.class-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.class-name {
    font-size: 18px;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
}

.class-actions {
    display: flex;
    gap: 10px;
}


.class-actions .btn {
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    border: none;
    cursor: pointer;
    transition: all 0.3s;
}

.class-actions .btn-primary {
    background: #3498db;
    color: white;
}

.class-actions .btn-primary:hover {
    background: #2980b9;
}

.class-actions .btn-outline-danger {
    background: transparent;
    color: #e74c3c;
    border: 1px solid #e74c3c;
}

.class-actions .btn-outline-danger:hover {
    background: #e74c3c;
    color: white;
}

.class-actions .btn-outline-warning {
    background: #f39c12;
    color: white;
    border: 1px solid #f39c12;
}

.class-actions .btn-outline-warning:hover {
    background: #e67e22;
    border-color: #e67e22;
}

.class-actions .btn-outline-info {
    background: #17a2b8;
    color: white;
    border: 1px solid #17a2b8;
}

.class-actions .btn-outline-info:hover {
    background: #138496;
    border-color: #138496;
}

.history-class {
    opacity: 0.8;
    border-left: 4px solid #6c757d;
}

.history-class .class-name {
    color: #6c757d;
}

.class-description {
    color: #7f8c8d;
    margin-bottom: 15px;
    font-size: 14px;
}

.class-stats {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
}

.stat-item {
    text-align: center;
}

.stat-label {
    font-size: 12px;
    color: #7f8c8d;
    display: block;
}

.stat-value {
    font-size: 16px;
    font-weight: 600;
    color: #2c3e50;
}

.competition-goal {
    background: #fff3cd;
    color: #856404;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    text-align: center;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #7f8c8d;
}

.empty-state i {
    color: #bdc3c7;
    margin-bottom: 20px;
}

.empty-state h3 {
    color: #2c3e50;
    margin-bottom: 10px;
}

/* 竞赛目标管理区域 */
.goals-section {
    background: white;
    margin: 20px 0;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.goals-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.goal-card {
    background: white;
    border: 1px solid #ecf0f1;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.3s, box-shadow 0.3s;
}

.goal-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.goal-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.goal-name {
    font-size: 18px;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
}

.goal-actions {
    display: flex;
    gap: 10px;
}

.goal-actions .btn {
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    border: none;
    cursor: pointer;
    transition: all 0.3s;
}

.goal-actions .btn-outline-warning {
    background: transparent;
    color: #f39c12;
    border: 1px solid #f39c12;
}

.goal-actions .btn-outline-warning:hover {
    background: #f39c12;
    color: white;
}

.goal-actions .btn-outline-danger {
    background: transparent;
    color: #e74c3c;
    border: 1px solid #e74c3c;
}

.goal-actions .btn-outline-danger:hover {
    background: #e74c3c;
    color: white;
}

.goal-description {
    color: #7f8c8d;
    margin-bottom: 15px;
    font-size: 14px;
}

.goal-timeline {
    display: flex;
    justify-content: space-between;
}

.timeline-item {
    text-align: center;
}

.timeline-label {
    font-size: 12px;
    color: #7f8c8d;
    display: block;
}

.timeline-value {
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
}

/* 模态框样式 */
.modal-content {
    border-radius: 8px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.modal-header {
    background: #f8f9fa;
    border-bottom: 1px solid #ecf0f1;
    border-radius: 8px 8px 0 0;
}

.modal-title {
    color: #2c3e50;
    font-weight: 600;
}

.modal-footer {
    background: #f8f9fa;
    border-top: 1px solid #ecf0f1;
    border-radius: 0 0 8px 8px;
}

.form-label {
    color: #2c3e50;
    font-weight: 500;
    margin-bottom: 8px;
}

.form-control {
    border: 1px solid #bdc3c7;
    border-radius: 6px;
    padding: 10px 12px;
    transition: border-color 0.3s, box-shadow 0.3s;
}

.form-control:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
}

.btn-secondary {
    background: #95a5a6;
    border-color: #95a5a6;
}

.btn-secondary:hover {
    background: #7f8c8d;
    border-color: #7f8c8d;
}

.btn-success {
    background: #27ae60;
    border-color: #27ae60;
}

.btn-success:hover {
    background: #229954;
    border-color: #229954;
}
</style>

    <!-- 主导航栏 -->
<div class="main-nav">
    <div class="container">
        <h1 class="nav-title">烧脑数学课堂管理系统</h1>
    </div>
</div>

        <div class="container">
    <!-- 系统概览 -->
    <div class="dashboard-section">
        <h2 class="dashboard-title">系统概览</h2>
        <div class="stats-grid">
            <div class="stat-card blue">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-number">{{ total_students }}</div>
                <div class="stat-label">总学生数</div>
            </div>
            <div class="stat-card green">
                <div class="stat-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="stat-number">{{ classes|length }}</div>
                <div class="stat-label">总班级数</div>
            </div>
            <div class="stat-card cyan">
                <div class="stat-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="stat-number">{{ competition_goals|length }}</div>
                <div class="stat-label">竞赛目标</div>
            </div>
        </div>
    </div>

    <!-- 最近课程活动 -->
    <div class="activity-section">
        <h2 class="activity-title">最近课程活动</h2>
        <div class="recent-courses-container">
            {% set recent_courses = [] %}
            {% for class_data in classes %}
                {% for course in class_data.courses %}
                    {% if course.get('current_round', 0) > 0 %}
                        {% set _ = recent_courses.append({
                            'class_id': class_data.id,
                            'class_name': class_data.name,
                            'course_id': course.id,
                            'course_name': course.get('name', '未命名课程'),
                            'created_date': class_data.get('created_date', '未知'),
                            'current_round': course.get('current_round', 0)
                        }) %}
                    {% endif %}
                {% endfor %}
            {% endfor %}
            
            {% for course in recent_courses[-4:] %}
            <div class="course-card">
                <div class="course-number">{{ course.course_name }}</div>
                <div class="course-class">{{ course.class_name }}</div>
                <div class="course-date">{{ course.created_date }}</div>
                <div class="course-status-badge">已结束</div>
                <div class="course-progress">
                    <div class="progress-bar">
                        <div class="progress-fill green" style="width: 100%;"></div>
                    </div>
                    <span class="progress-text">已完成</span>
                </div>
                <button class="view-course-report-btn" onclick="window.location.href='/reports/{{ course.id }}'">
                    <i class="fas fa-chart-line me-1"></i>查看报告
                </button>
            </div>
            {% endfor %}
            
            {% if not recent_courses %}
            <div class="empty-courses">
                <i class="fas fa-book fa-2x mb-3"></i>
                <h4>暂无课程活动</h4>
                <p>开始创建课程来查看活动记录</p>
            </div>
            {% endif %}
        </div>
    </div>

            <!-- 班级管理区域 -->
            <div class="classes-section">
                <div class="section-header">
            <h2 class="section-title">班级管理</h2>
            <button class="create-btn" onclick="showCreateClassModal()">
                <i class="fas fa-plus me-2"></i>创建新班级
                    </button>
                </div>
                
                <div class="classes-grid" id="classesGrid">
                    {% for class_data in classes %}
                {% if not class_data.get('is_ended', False) %}
                    <div class="class-card" data-class-id="{{ class_data.id }}">
                        <div class="class-card-header">
                            <h3 class="class-name">{{ class_data.name }}</h3>
                            <div class="class-actions">
                        <button class="btn btn-primary" onclick="enterClass('{{ class_data.id }}')">
                            <i class="fas fa-door-open me-2"></i>进入班级
                                </button>
                        <button class="btn btn-outline-danger" onclick="endClass('{{ class_data.id }}')">
                            <i class="fas fa-flag-checkered me-2"></i>结束
                                </button>
                            </div>
                        </div>
                        
                        <div class="class-card-body">
                        <p class="class-description">{{ class_data.description or '暂无描述' }}</p>
                            
                            <div class="class-stats">
                                <div class="stat-item">
                                <span class="stat-label">学生数:</span>
                                    <span class="stat-value">{{ class_data.students|length }}</span>
                                </div>
                                <div class="stat-item">
                                <span class="stat-label">课程数:</span>
                                    <span class="stat-value">{{ class_data.courses|length }}</span>
                                </div>
                                <div class="stat-item">
                                <span class="stat-label">创建时间:</span>
                                    <span class="stat-value">{{ class_data.created_date }}</span>
                                </div>
                            </div>
                            
                        </div>
                            {% if class_data.competition_goal_id %}
                            <div class="competition-goal">
                                <i class="fas fa-trophy me-1"></i>
                            <span>竞赛目标已激活</span>
                        </div>
                        {% endif %}
                    </div>
                {% endif %}
                    {% endfor %}
                    
                    {% if not classes %}
                    <div class="empty-state">
                        <i class="fas fa-users fa-3x mb-3"></i>
                <h3>暂无班级</h3>
                <p>创建您的第一个班级开始使用！</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 竞赛目标管理区域 -->
            <div class="goals-section">
                <div class="section-header">
            <h2 class="section-title">竞赛目标管理</h2>
            <button class="create-btn" onclick="showCreateGoalModal()">
                <i class="fas fa-plus me-2"></i>创建新目标
                    </button>
                </div>
                
                <div class="goals-grid" id="goalsGrid">
                    {% for goal_data in competition_goals %}
                    <div class="goal-card" data-goal-id="{{ goal_data.id }}">
                        <div class="goal-card-header">
                            <h3 class="goal-name">{{ goal_data.name }}</h3>
                            <div class="goal-actions">
                        <button class="btn btn-outline-warning" onclick="assignGoal('{{ goal_data.id }}')">
                            <i class="fas fa-link me-1"></i>分配
                                </button>
                        <button class="btn btn-outline-danger" onclick="deleteGoal('{{ goal_data.id }}')">
                            <i class="fas fa-trash me-1"></i>删除
                                </button>
                            </div>
                        </div>
                        
                        <div class="goal-card-body">
                    <p class="goal-description">{{ goal_data.description or '暂无描述' }}</p>
                            
                            <div class="goal-timeline">
                                <div class="timeline-item">
                            <span class="timeline-label">竞赛日期:</span>
                                    <span class="timeline-value">{{ goal_data.goal_date }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if not competition_goals %}
                    <div class="empty-state">
                        <i class="fas fa-trophy fa-3x mb-3"></i>
                <h3>暂无竞赛目标</h3>
                <p>创建竞赛目标来激励您的学生！</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 历史班级区域 -->
    <div class="classes-section">
        <div class="section-header">
            <h2 class="section-title">历史班级</h2>
        </div>
                
        <div class="classes-grid" id="historyClassesGrid">
            {% for class_data in classes %}
                {% if class_data.get('is_ended', False) %}
                <div class="class-card history-class" data-class-id="{{ class_data.id }}">
                <div class="class-card-header">
                    <h3 class="class-name">{{ class_data.name }}</h3>
                    <div class="class-actions">
                        <button class="btn btn-outline-info" onclick="viewHistoryClass('{{ class_data.id }}')">
                            <i class="fas fa-eye me-2"></i>查看历史
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteClass('{{ class_data.id }}')">
                            <i class="fas fa-trash me-2"></i>删除
                        </button>
                    </div>
                </div>
                    
                    <div class="class-card-body">
                        <p class="class-description">{{ class_data.description or '暂无描述' }}</p>
                        
                        <div class="class-stats">
                            <div class="stat-item">
                                <span class="stat-label">学生数:</span>
                                <span class="stat-value">{{ class_data.students|length }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">课程数:</span>
                                <span class="stat-value">{{ class_data.courses|length }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">结束时间:</span>
                                <span class="stat-value">{{ class_data.ended_date or '未知' }}</span>
                            </div>
                        </div>
                        {% if class_data.competition_goal_id %}
                        <div class="competition-goal">
                            <i class="fas fa-trophy me-1"></i>
                            <span>竞赛目标已完成</span>
                    </div>
                    {% endif %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}
            
            {% set has_history = classes|selectattr('is_ended', 'equalto', True)|list %}
            {% if not has_history %}
            <div class="empty-state">
                <i class="fas fa-history fa-3x mb-3"></i>
                <h3>暂无历史班级</h3>
                <p>结束的班级将显示在这里</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 创建班级模态框 -->
<div class="modal fade" id="createClassModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">创建新班级</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createClassForm">
                    <div class="mb-3">
                        <label for="className" class="form-label">班级名称</label>
                        <input type="text" class="form-control" id="className" required>
                    </div>
                    <div class="mb-3">
                        <label for="classDescription" class="form-label">班级描述</label>
                        <textarea class="form-control" id="classDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createClass()">创建班级</button>
            </div>
        </div>
    </div>
</div>

<!-- 创建竞赛目标模态框 -->
<div class="modal fade" id="createGoalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">创建竞赛目标</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createGoalForm">
                    <div class="mb-3">
                        <label for="goalName" class="form-label">目标名称</label>
                        <input type="text" class="form-control" id="goalName" required>
                    </div>
                    <div class="mb-3">
                        <label for="goalDescription" class="form-label">目标描述</label>
                        <textarea class="form-control" id="goalDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="goalDate" class="form-label">竞赛日期</label>
                        <input type="date" class="form-control" id="goalDate" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="createGoal()">创建目标</button>
            </div>
        </div>
    </div>
</div>

<script>
// 显示创建班级模态框
function showCreateClassModal() {
    const modal = new bootstrap.Modal(document.getElementById('createClassModal'));
    modal.show();
}

// 显示创建竞赛目标模态框
function showCreateGoalModal() {
    const modal = new bootstrap.Modal(document.getElementById('createGoalModal'));
    modal.show();
}

// 创建班级
function createClass() {
    const name = document.getElementById('className').value.trim();
    const description = document.getElementById('classDescription').value.trim();
    
    if (!name) {
        alert('请输入班级名称');
        return;
    }
    
    fetch('/api/create_class', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || '创建班级失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('创建班级时发生错误');
    });
}

// 创建竞赛目标
function createGoal() {
    const name = document.getElementById('goalName').value.trim();
    const description = document.getElementById('goalDescription').value.trim();
    const goalDate = document.getElementById('goalDate').value;
    
    if (!name || !goalDate) {
        alert('请填写所有必填字段');
        return;
    }
    
    fetch('/api/create_competition_goal', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            description: description,
            goal_date: goalDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || '创建目标失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('创建目标时发生错误');
    });
}

// 进入班级
function enterClass(classId) {
    window.location.href = `/class/${classId}`;
}

// 结束班级
function endClass(classId) {
    if (confirm('确定要结束这个班级吗？班级将被移动到历史班级中。')) {
        fetch(`/api/end_class/${classId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || '结束班级失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('结束班级时发生错误');
        });
    }
}

// 查看历史班级
function viewHistoryClass(classId) {
    window.location.href = `/class/${classId}`;
}

// 删除班级
function deleteClass(classId) {
    if (confirm('确定要删除这个班级吗？此操作无法撤销。')) {
        fetch(`/api/delete_class/${classId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || '删除班级失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('删除班级时发生错误');
        });
    }
}

// 分配竞赛目标
function assignGoal(goalId) {
    // 创建班级选择对话框
    const classOptions = Object.entries({{ classes|tojson }}).map(([id, classData]) => 
        `<option value="${id}">${classData.name}</option>`
    ).join('');
    
    if (!classOptions) {
        alert('没有可用的班级。请先创建一个班级。');
        return;
    }
    
    const classSelect = prompt(`选择要分配此目标的班级：\n\n${Object.entries({{ classes|tojson }}).map(([id, classData]) => `${id}: ${classData.name}`).join('\n')}\n\n请输入班级ID：`);
    
    if (classSelect && classSelect.trim()) {
        fetch('/api/assign_goal_to_class', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                goal_id: goalId,
                class_id: classSelect.trim()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('目标分配成功！');
                location.reload();
            } else {
                alert(data.message || '分配目标失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('分配目标时发生错误');
        });
    }
}

// 删除竞赛目标
function deleteGoal(goalId) {
    if (confirm('确定要删除这个竞赛目标吗？')) {
        fetch(`/api/delete_competition_goal/${goalId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || '删除目标失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('删除目标时发生错误');
        });
    }
}
</script>
{% endblock %}
