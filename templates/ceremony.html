{% extends "base.html" %}

{% block title %}é¢å¥–å…¸ç¤¼ - Classroom Management System{% endblock %}

{% block content %}
<div class="ceremony-container">
    <!-- é¢å¥–å…¸ç¤¼èƒŒæ™¯ -->
    <div class="ceremony-background">
        <div class="celebration-particles"></div>
        <div class="celebration-confetti"></div>
        <div class="fireworks-left"></div>
        <div class="fireworks-right"></div>
    </div>

    <!-- ä¸»æ ‡é¢˜ -->
    <div class="ceremony-header">
        <h1 class="ceremony-title">
            <i class="fas fa-trophy ceremony-icon"></i>
            Classroom Awards Ceremony
            <i class="fas fa-trophy ceremony-icon"></i>
        </h1>
        <p class="ceremony-subtitle">Congratulations to all students for completing the challenge!</p>
    </div>

    <!-- é¢†å¥–å°åŒºåŸŸ -->
    <div class="podium-container">
        <!-- ç¬¬äºŒå -->
        <div class="podium-place second-place" id="secondPlace">
            <div class="podium-base">
                <div class="podium-number">2</div>
                <div class="podium-trophy">
                    <i class="fas fa-trophy silver-trophy"></i>
                </div>
            </div>
            <div class="student-on-podium" id="secondStudent">
                <div class="student-avatar-large">
                    <span class="student-emoji-large">ğŸ˜Š</span>
                    <div class="medal-on-neck silver-medal-neck">
                        <i class="fas fa-medal"></i>
                    </div>
                </div>
                <div class="student-name-large">ç¬¬äºŒå</div>
                <div class="student-score-large">0åˆ†</div>
            </div>
        </div>

        <!-- ç¬¬ä¸€å -->
        <div class="podium-place first-place" id="firstPlace">
            <div class="podium-base">
                <div class="podium-number">1</div>
                <div class="podium-trophy">
                    <i class="fas fa-trophy gold-trophy"></i>
                </div>
            </div>
            <div class="student-on-podium" id="firstStudent">
                <div class="student-avatar-large">
                    <span class="student-emoji-large">ğŸ˜Š</span>
                    <div class="medal-on-neck gold-medal-neck">
                        <i class="fas fa-medal"></i>
                    </div>
                </div>
                <div class="student-name-large">ç¬¬ä¸€å</div>
                <div class="student-score-large">0åˆ†</div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰å -->
        <div class="podium-place third-place" id="thirdPlace">
            <div class="podium-base">
                <div class="podium-number">3</div>
                <div class="podium-trophy">
                    <i class="fas fa-trophy bronze-trophy"></i>
                </div>
            </div>
            <div class="student-on-podium" id="thirdStudent">
                <div class="student-avatar-large">
                    <span class="student-emoji-large">ğŸ˜Š</span>
                    <div class="medal-on-neck bronze-medal-neck">
                        <i class="fas fa-medal"></i>
                    </div>
                </div>
                <div class="student-name-large">ç¬¬ä¸‰å</div>
                <div class="student-score-large">0åˆ†</div>
            </div>
        </div>
    </div>

    <!-- å…¶ä»–å­¦ç”Ÿæ¬¢å‘¼åŒºåŸŸ -->
    <div class="cheering-students" id="cheeringStudents">
        <!-- å…¶ä»–å­¦ç”Ÿå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="ceremony-controls">
        <button class="btn btn-success btn-lg" onclick="location.href='/reports/' + classId">
            <i class="fas fa-chart-bar me-2"></i>æŸ¥çœ‹æŠ¥å‘Š
        </button>
        <button class="btn btn-warning btn-lg" onclick="location.href='/'">
            <i class="fas fa-home me-2"></i>è¿”å›é¦–é¡µ
        </button>
    </div>
</div>

<script>
let studentScores = {{ student_scores | tojson }};
let classId = '{{ course.class_id }}';

// åˆå§‹åŒ–é¢å¥–å…¸ç¤¼
document.addEventListener('DOMContentLoaded', function() {
    console.log('å­¦ç”Ÿåˆ†æ•°æ•°æ®:', studentScores);
    setupCeremony();
});

// è®¾ç½®é¢å¥–å…¸ç¤¼
function setupCeremony() {
    console.log('å¼€å§‹è®¾ç½®é¢å¥–å…¸ç¤¼ï¼Œå­¦ç”Ÿæ•°æ®:', studentScores);
    const students = studentScores || [];
    console.log('å­¦ç”Ÿæ•°ç»„:', students);
    
    if (students.length === 0) {
        console.log('æ²¡æœ‰å­¦ç”Ÿæ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯');
        // å¦‚æœæ²¡æœ‰å­¦ç”Ÿï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
        showNoStudentsMessage();
        return;
    }
    
    // æŒ‰åˆ†æ•°æ’åºå­¦ç”Ÿ
    const sortedStudents = students.sort((a, b) => b.score - a.score);
    console.log('æ’åºåçš„å­¦ç”Ÿ:', sortedStudents);
    
    // è®¾ç½®å‰ä¸‰å
    setupTopThree(sortedStudents);
    
    // è®¾ç½®å…¶ä»–å­¦ç”Ÿ
    setupOtherStudents(sortedStudents.slice(3));
    
    // å¼€å§‹åŠ¨ç”»æ•ˆæœ
    startCeremonyAnimation();
}

// è®¾ç½®å‰ä¸‰å
function setupTopThree(sortedStudents) {
    // ç¬¬ä¸€å
    if (sortedStudents[0]) {
        const firstStudent = sortedStudents[0];
        const firstElement = document.getElementById('firstStudent');
        if (firstElement) {
            firstElement.querySelector('.student-emoji-large').textContent = 'ğŸ˜Š';
            firstElement.querySelector('.student-name-large').textContent = firstStudent.name;
            firstElement.querySelector('.student-score-large').textContent = firstStudent.score + 'åˆ†';
            firstElement.querySelector('.student-avatar-large').style.backgroundColor = firstStudent.avatar_color;
        }
    }
    
    // ç¬¬äºŒå
    if (sortedStudents[1]) {
        const secondStudent = sortedStudents[1];
        const secondElement = document.getElementById('secondStudent');
        if (secondElement) {
            secondElement.querySelector('.student-emoji-large').textContent = 'ğŸ˜Š';
            secondElement.querySelector('.student-name-large').textContent = secondStudent.name;
            secondElement.querySelector('.student-score-large').textContent = secondStudent.score + 'åˆ†';
            secondElement.querySelector('.student-avatar-large').style.backgroundColor = secondStudent.avatar_color;
        }
    }
    
    // ç¬¬ä¸‰å
    if (sortedStudents[2]) {
        const thirdStudent = sortedStudents[2];
        const thirdElement = document.getElementById('thirdStudent');
        const thirdPlace = document.getElementById('thirdPlace');
        if (thirdElement && thirdPlace) {
            thirdElement.querySelector('.student-emoji-large').textContent = 'ğŸ˜Š';
            thirdElement.querySelector('.student-name-large').textContent = thirdStudent.name;
            thirdElement.querySelector('.student-score-large').textContent = thirdStudent.score + 'åˆ†';
            thirdElement.querySelector('.student-avatar-large').style.backgroundColor = thirdStudent.avatar_color;
            thirdPlace.style.display = 'flex';  // æ˜¾ç¤ºç¬¬ä¸‰åä½ç½®
        }
    } else {
        // æ²¡æœ‰ç¬¬ä¸‰åå­¦ç”Ÿæ—¶éšè—ç¬¬ä¸‰åä½ç½®
        const thirdPlace = document.getElementById('thirdPlace');
        if (thirdPlace) {
            thirdPlace.style.display = 'none';
        }
    }
}

// è®¾ç½®å…¶ä»–å­¦ç”Ÿ
function setupOtherStudents(otherStudents) {
    const cheeringContainer = document.getElementById('cheeringStudents');
    if (!cheeringContainer) return;
    
    cheeringContainer.innerHTML = '';
    
    otherStudents.forEach(student => {
        const studentElement = document.createElement('div');
        studentElement.className = 'cheering-student';
        studentElement.innerHTML = `
            <div class="cheering-student-avatar" style="background-color: ${student.avatar_color}">
                <span class="cheering-student-emoji">ğŸ‘</span>
            </div>
            <div class="cheering-student-name">${student.name}</div>
            <div class="cheering-student-score">${student.score}åˆ†</div>
        `;
        cheeringContainer.appendChild(studentElement);
    });
}

// æ˜¾ç¤ºæ²¡æœ‰å­¦ç”Ÿçš„æç¤º
function showNoStudentsMessage() {
    const cheeringContainer = document.getElementById('cheeringStudents');
    if (cheeringContainer) {
        cheeringContainer.innerHTML = `
            <div class="no-students-message">
                <i class="fas fa-users fa-3x"></i>
                <h3>è¿˜æ²¡æœ‰å­¦ç”Ÿå‚ä¸</h3>
                <p>è¯·å…ˆæ·»åŠ å­¦ç”Ÿå¹¶å¼€å§‹è¯¾å ‚æ´»åŠ¨</p>
            </div>
        `;
    }
}

// å¼€å§‹é¢å¥–å…¸ç¤¼åŠ¨ç”»
function startCeremonyAnimation() {
    // å»¶è¿Ÿæ˜¾ç¤ºå„ä¸ªå…ƒç´ 
    setTimeout(() => {
        document.querySelector('.ceremony-header').style.opacity = '1';
        document.querySelector('.ceremony-header').style.transform = 'translateY(0)';
    }, 500);
    
    setTimeout(() => {
        document.querySelector('.podium-container').style.opacity = '1';
        document.querySelector('.podium-container').style.transform = 'translateY(0)';
    }, 1000);
    
    setTimeout(() => {
        document.querySelector('.cheering-students').style.opacity = '1';
        document.querySelector('.cheering-students').style.transform = 'translateY(0)';
    }, 1500);
    
    setTimeout(() => {
        document.querySelector('.ceremony-controls').style.opacity = '1';
        document.querySelector('.ceremony-controls').style.transform = 'translateY(0)';
    }, 2000);
}

</script>
{% endblock %}
