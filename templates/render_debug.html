<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Render数据库调试工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .debug-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .debug-card {
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
        }
        .debug-body {
            padding: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-danger { background-color: #dc3545; }
        .status-info { background-color: #17a2b8; }
        .json-viewer {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .btn-debug {
            margin: 5px;
        }
        .log-entry {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-info { background-color: #d1ecf1; border-left: 4px solid #17a2b8; }
        .log-warning { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        .log-error { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .log-success { background-color: #d4edda; border-left: 4px solid #28a745; }
        .table-responsive {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <div class="debug-card">
            <div class="debug-header">
                <h2><i class="fas fa-database me-2"></i>Render数据库调试工具</h2>
                <p class="mb-0">专门用于调试Render平台上的PostgreSQL数据库连接和操作问题</p>
            </div>
            <div class="debug-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>数据库调试操作</h5>
                        <button class="btn btn-primary btn-debug" onclick="testConnection()">
                            <i class="fas fa-plug me-1"></i>测试连接
                        </button>
                        <button class="btn btn-info btn-debug" onclick="checkTables()">
                            <i class="fas fa-table me-1"></i>检查表结构
                        </button>
                        <button class="btn btn-success btn-debug" onclick="checkData()">
                            <i class="fas fa-database me-1"></i>检查数据
                        </button>
                        <button class="btn btn-warning btn-debug" onclick="testOperations()">
                            <i class="fas fa-cogs me-1"></i>测试操作
                        </button>
                        <button class="btn btn-danger btn-debug" onclick="fixDatabase()">
                            <i class="fas fa-wrench me-1"></i>修复数据库
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h5>环境信息</h5>
                        <button class="btn btn-secondary btn-debug" onclick="checkEnvironment()">
                            <i class="fas fa-info-circle me-1"></i>检查环境
                        </button>
                        <button class="btn btn-dark btn-debug" onclick="clearLogs()">
                            <i class="fas fa-trash me-1"></i>清除日志
                        </button>
                        <div id="environmentInfo" class="mt-3">
                            <p class="text-muted">点击"检查环境"查看详细信息</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="debug-card">
            <div class="debug-header">
                <h4><i class="fas fa-chart-bar me-2"></i>数据库状态</h4>
            </div>
            <div class="debug-body">
                <div id="databaseStatus">
                    <p class="text-muted">点击"测试连接"按钮查看数据库连接状态</p>
                </div>
            </div>
        </div>

        <div class="debug-card">
            <div class="debug-header">
                <h4><i class="fas fa-list me-2"></i>调试日志</h4>
            </div>
            <div class="debug-body">
                <div id="debugLogs" style="max-height: 300px; overflow-y: auto;">
                    <p class="text-muted">调试日志将在这里显示...</p>
                </div>
            </div>
        </div>

        <div class="debug-card">
            <div class="debug-header">
                <h4><i class="fas fa-code me-2"></i>原始数据</h4>
            </div>
            <div class="debug-body">
                <div id="rawData" class="json-viewer">
                    <p class="text-muted">原始数据将在这里显示...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 调试日志数组
        let debugLogs = [];

        // 添加日志条目
        function addLogEntry(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp: timestamp,
                message: message,
                type: type
            };
            debugLogs.push(logEntry);
            updateLogDisplay();
        }

        // 更新日志显示
        function updateLogDisplay() {
            const logsContainer = document.getElementById('debugLogs');
            logsContainer.innerHTML = '';
            
            debugLogs.slice(-50).reverse().forEach(log => {
                const logDiv = document.createElement('div');
                logDiv.className = `log-entry log-${log.type}`;
                logDiv.innerHTML = `<strong>${log.timestamp}</strong> ${log.message}`;
                logsContainer.appendChild(logDiv);
            });
        }

        // 测试数据库连接
        async function testConnection() {
            addLogEntry('正在测试数据库连接...', 'info');
            
            try {
                const response = await fetch('/debug/connection');
                const data = await response.json();
                
                if (data.success) {
                    addLogEntry('数据库连接测试成功', 'success');
                    displayConnectionStatus(data);
                } else {
                    addLogEntry(`数据库连接测试失败: ${data.message}`, 'error');
                    displayConnectionStatus(data);
                }
                displayRawData(data);
            } catch (error) {
                addLogEntry(`网络错误: ${error.message}`, 'error');
            }
        }

        // 检查表结构
        async function checkTables() {
            addLogEntry('正在检查表结构...', 'info');
            
            try {
                const response = await fetch('/debug/tables');
                const data = await response.json();
                
                if (data.success) {
                    addLogEntry(`找到 ${data.tables.length} 个表`, 'success');
                    displayTableInfo(data);
                } else {
                    addLogEntry(`检查表结构失败: ${data.message}`, 'error');
                }
                displayRawData(data);
            } catch (error) {
                addLogEntry(`网络错误: ${error.message}`, 'error');
            }
        }

        // 检查数据内容
        async function checkData() {
            addLogEntry('正在检查数据内容...', 'info');
            
            try {
                const response = await fetch('/debug/data');
                const data = await response.json();
                
                if (data.success) {
                    addLogEntry('数据内容检查完成', 'success');
                    displayDataInfo(data);
                } else {
                    addLogEntry(`检查数据内容失败: ${data.message}`, 'error');
                }
                displayRawData(data);
            } catch (error) {
                addLogEntry(`网络错误: ${error.message}`, 'error');
            }
        }

        // 测试数据库操作
        async function testOperations() {
            addLogEntry('正在测试数据库操作...', 'info');
            
            try {
                const response = await fetch('/debug/test_operations');
                const data = await response.json();
                
                if (data.success) {
                    addLogEntry('数据库操作测试完成', 'success');
                    displayTestResults(data);
                } else {
                    addLogEntry(`测试数据库操作失败: ${data.message}`, 'error');
                }
                displayRawData(data);
            } catch (error) {
                addLogEntry(`网络错误: ${error.message}`, 'error');
            }
        }

        // 修复数据库
        async function fixDatabase() {
            if (!confirm('确定要修复数据库吗？这将修改数据库结构。')) {
                return;
            }
            
            addLogEntry('正在修复数据库...', 'warning');
            
            try {
                const response = await fetch('/debug/fix_database');
                const data = await response.json();
                
                if (data.success) {
                    addLogEntry('数据库修复完成', 'success');
                    displayFixResults(data);
                } else {
                    addLogEntry(`数据库修复失败: ${data.message}`, 'error');
                }
                displayRawData(data);
            } catch (error) {
                addLogEntry(`网络错误: ${error.message}`, 'error');
            }
        }

        // 检查环境变量
        async function checkEnvironment() {
            addLogEntry('正在检查环境变量...', 'info');
            
            try {
                const response = await fetch('/debug/environment');
                const data = await response.json();
                
                if (data.success) {
                    addLogEntry('环境变量检查完成', 'success');
                    displayEnvironmentInfo(data);
                } else {
                    addLogEntry(`检查环境变量失败: ${data.message}`, 'error');
                }
                displayRawData(data);
            } catch (error) {
                addLogEntry(`网络错误: ${error.message}`, 'error');
            }
        }

        // 显示连接状态
        function displayConnectionStatus(data) {
            const statusContainer = document.getElementById('databaseStatus');
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>连接状态</h6>
                        <p>
                            <span class="status-indicator ${data.success ? 'status-success' : 'status-danger'}"></span>
                            ${data.success ? '连接正常' : '连接失败'}
                        </p>
                        <p><strong>消息:</strong> ${data.message}</p>
                        ${data.test_value ? `<p><strong>测试值:</strong> ${data.test_value}</p>` : ''}
                    </div>
                    <div class="col-md-6">
                        <h6>数据库信息</h6>
                        <p><strong>URL:</strong> ${data.database_url || '未提供'}</p>
                        ${data.error_type ? `<p><strong>错误类型:</strong> ${data.error_type}</p>` : ''}
                    </div>
                </div>
            `;
            
            statusContainer.innerHTML = html;
        }

        // 显示表信息
        function displayTableInfo(data) {
            const statusContainer = document.getElementById('databaseStatus');
            
            let html = `
                <div class="row">
                    <div class="col-12">
                        <h6>数据库表结构</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>表名</th>
                                        <th>记录数</th>
                                        <th>字段数</th>
                                        <th>字段详情</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            Object.entries(data.table_info).forEach(([tableName, info]) => {
                html += `
                    <tr>
                        <td><strong>${tableName}</strong></td>
                        <td>${info.record_count}</td>
                        <td>${info.columns.length}</td>
                        <td>
                            <small>
                                ${info.columns.map(col => `${col.name}(${col.type})`).join(', ')}
                            </small>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            statusContainer.innerHTML = html;
        }

        // 显示数据信息
        function displayDataInfo(data) {
            const statusContainer = document.getElementById('databaseStatus');
            
            let html = `
                <div class="row">
                    <div class="col-12">
                        <h6>数据内容概览</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>表名</th>
                                        <th>状态</th>
                                        <th>记录数</th>
                                        <th>最新记录</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            Object.entries(data.data_info).forEach(([tableName, info]) => {
                html += `
                    <tr>
                        <td><strong>${tableName}</strong></td>
                        <td>
                            <span class="status-indicator ${info.exists ? 'status-success' : 'status-danger'}"></span>
                            ${info.exists ? '存在' : '不存在'}
                        </td>
                        <td>${info.count || 0}</td>
                        <td>
                            <small>
                                ${info.latest_records && info.latest_records.length > 0 ? 
                                    JSON.stringify(info.latest_records[0]).substring(0, 100) + '...' : 
                                    '无数据'}
                            </small>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            statusContainer.innerHTML = html;
        }

        // 显示测试结果
        function displayTestResults(data) {
            const statusContainer = document.getElementById('databaseStatus');
            
            let html = `
                <div class="row">
                    <div class="col-12">
                        <h6>数据库操作测试结果</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>测试项目</th>
                                        <th>结果</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            data.test_results.forEach(test => {
                html += `
                    <tr>
                        <td>${test.test}</td>
                        <td>
                            <span class="status-indicator ${test.result.includes('成功') ? 'status-success' : 'status-danger'}"></span>
                            ${test.result}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            statusContainer.innerHTML = html;
        }

        // 显示修复结果
        function displayFixResults(data) {
            const statusContainer = document.getElementById('databaseStatus');
            
            let html = `
                <div class="row">
                    <div class="col-12">
                        <h6>数据库修复结果</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>修复项目</th>
                                        <th>结果</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            data.fix_results.forEach(fix => {
                html += `
                    <tr>
                        <td>${fix.fix}</td>
                        <td>
                            <span class="status-indicator ${fix.result.includes('成功') ? 'status-success' : 'status-danger'}"></span>
                            ${fix.result}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            statusContainer.innerHTML = html;
        }

        // 显示环境信息
        function displayEnvironmentInfo(data) {
            const envContainer = document.getElementById('environmentInfo');
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>环境状态</h6>
                        <p>
                            <span class="status-indicator ${data.is_render ? 'status-success' : 'status-warning'}"></span>
                            ${data.is_render ? 'Render环境' : '非Render环境'}
                        </p>
                        <p><strong>Python版本:</strong> ${data.python_version}</p>
                        <p><strong>工作目录:</strong> ${data.working_directory}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>环境变量</h6>
                        <ul class="list-unstyled">
            `;
            
            Object.entries(data.environment_variables).forEach(([key, value]) => {
                html += `<li><strong>${key}:</strong> ${value}</li>`;
            });
            
            html += `
                        </ul>
                    </div>
                </div>
            `;
            
            envContainer.innerHTML = html;
        }

        // 显示原始数据
        function displayRawData(data) {
            const rawDataContainer = document.getElementById('rawData');
            rawDataContainer.textContent = JSON.stringify(data, null, 2);
        }

        // 清除日志
        function clearLogs() {
            debugLogs = [];
            updateLogDisplay();
            addLogEntry('日志已清除', 'info');
        }

        // 页面加载时自动检查环境
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('Render数据库调试工具已加载', 'success');
            checkEnvironment();
        });

        // 定期刷新状态
        setInterval(() => {
            testConnection();
        }, 60000); // 每60秒刷新一次
    </script>
</body>
</html>
