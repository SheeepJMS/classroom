{% extends "base.html" %}

{% block title %}{{ student_name }} - å­¦ä¹ è¡¨ç°æŠ¥å‘Š{% endblock %}

{% block content %}
<style>
    body {
        font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', 'PingFang SC', 'Hiragino Sans GB', 'Helvetica Neue', Arial, sans-serif;
        font-weight: 400;
        background-color: #f5f5f5;
    }
    
    .report-container {
        display: flex;
        gap: 20px;
        max-width: 1400px;
        margin: 20px auto;
        padding: 0 20px;
    }
    
    .report-left {
        flex: 1;
        min-width: 0;
    }
    
    .report-right {
        flex: 1;
        min-width: 0;
        overflow-x: hidden;
    }
    
    .card {
        margin-bottom: 20px;
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
        font-weight: 600;
    }
    
    /* å³ä¾§æ»šåŠ¨å®¹å™¨ */
    .scrollable-container {
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 10px;
    }
    
    .scrollable-container::-webkit-scrollbar {
        width: 6px;
    }
    
    .scrollable-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .scrollable-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }
    
    .scrollable-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    /* å­¦ä¹ å‚ä¸è®°å½•å¸ƒå±€ */
    .round-record-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
    }
    
    .round-record-row1 {
        display: grid;
        grid-template-columns: 70px 70px 50px 60px 60px 60px 80px;
        gap: 8px;
        align-items: center;
        width: 100%;
        max-width: 100%;
    }
    
    .round-record-row2 {
        display: flex;
        align-items: center;
        gap: 8px;
        padding-left: 140px; /* å¯¹é½åˆ°"å‚ä¸çŠ¶æ€"åˆ—çš„ä½ç½®ï¼š70px(è½®æ¬¡) + 70px(å‚ä¸çŠ¶æ€) */
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
    }
    
    .round-record-row1 > div,
    .round-record-row2 > div {
        display: flex;
        align-items: center;
        justify-content: flex-start;
    }
    
    /* é€æ˜å ä½æ ‡ç­¾ */
    .badge.bg-transparent {
        visibility: hidden;
    }
    
    .round-accuracy-container {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
    }
    
    .round-accuracy-container .progress {
        flex-shrink: 0;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 992px) {
        .report-container {
            flex-direction: column;
            margin: 10px auto;
            padding: 0 10px;
        }
        
        .report-right {
            width: 100%;
        }
        
        .report-right .card {
            height: auto !important;
            max-height: 600px;
        }
        
        .scrollable-container {
            max-height: 500px;
        }
        
        .round-record-row1 {
            grid-template-columns: 60px 60px 40px 50px 50px 50px 70px;
            gap: 6px;
            font-size: 0.9rem;
        }
        
        .round-record-row2 {
            padding-left: 120px; /* 60px(è½®æ¬¡) + 60px(å‚ä¸çŠ¶æ€) */
            max-width: calc(100% - 120px);
        }
        
        .round-record-item .badge {
            font-size: 0.75rem;
            padding: 0.25em 0.5em;
        }
        
        .round-accuracy-container {
            max-width: 100%;
        }
        
        .round-accuracy-container .progress {
            width: 80px !important;
        }
    }
</style>

<div class="report-container">
    <!-- å·¦ä¾§å†…å®¹åŒºåŸŸ -->
    <div class="report-left">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="m-0">{{ student_name }} - æŠ¥å‘Šè¯¦æƒ…</h4>
            <a class="btn btn-sm btn-outline-primary" href="/student_report_center/{{ student.id }}"><i class="fas fa-list me-1"></i>è¿”å›åˆ—è¡¨</a>
        </div>
        
        <!-- é¡¶éƒ¨å¡ç‰‡ -->
        <div class="card shadow-sm">
            <div class="card-body d-flex align-items-center gap-3">
                <div style="width:80px;height:80px;border-radius:50%;background: {{ student.avatar_color or '#4ecdc4' }};display:flex;align-items:center;justify-content:center;font-size:40px;color:#fff;">ğŸ˜Š</div>
                <div class="flex-grow-1">
                    <div class="fw-bold fs-5">{{ course_data.name }}</div>
                    <small class="text-muted"><i class="fas fa-calendar me-1"></i>{{ current_date }}</small>
                </div>
            </div>
        </div>

        <!-- ç«èµ›ç›®æ ‡ -->
        <div class="card shadow-sm">
            <div class="card-header py-2 bg-warning text-dark"><strong><i class="fas fa-trophy me-1"></i>ç«èµ›ç›®æ ‡</strong></div>
            <div class="card-body p-3 d-flex text-center" style="gap:12px">
                <div class="flex-fill">
                    <div class="text-warning mb-1"><i class="fas fa-trophy"></i></div>
                    <div class="small">{{ competition_goal_name or 'æš‚æ— ' }}</div>
                </div>
                <div class="flex-fill">
                    <div class="text-info mb-1"><i class="fas fa-calendar"></i></div>
                    <div class="small">{{ competition_goal_date or 'æš‚æ— ' }}</div>
                </div>
                <div class="flex-fill">
                    <div class="text-primary mb-1"><i class="fas fa-clock"></i></div>
                    <div class="small">{{ days_to_competition if days_to_competition is not none else 'æš‚æ— ' }}å¤©</div>
                </div>
                <div class="flex-fill">
                    <div class="text-success mb-1"><i class="fas fa-file-alt"></i></div>
                    <div class="small">{{ classes_before_competition if classes_before_competition is not none else 'æš‚æ— ' }}èŠ‚</div>
                </div>
            </div>
        </div>

        <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
        <div class="row g-3">
            <div class="col-4">
                <div class="card text-center shadow-sm" style="background: linear-gradient(135deg,#FFF3CD,#FFE8A1);">
                    <div class="card-body p-3">
                        <div class="small text-muted mb-2">å¾—åˆ†</div>
                        <div class="h3 mb-0">{{ student_total_score }}</div>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card text-center shadow-sm" style="background: linear-gradient(135deg,#D1E7DD,#A3CFBB);">
                    <div class="card-body p-3">
                        <div class="small text-muted mb-2">æ­£ç¡®ç‡</div>
                        <div class="h3 mb-0">{{ accuracy }}%</div>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card text-center shadow-sm" style="background: linear-gradient(135deg,#CCE5FF,#99CCFF);">
                    <div class="card-body p-3">
                        <div class="small text-muted mb-2">å‚ä¸ç‡</div>
                        <div class="h3 mb-0">{{ participation_rate }}%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¡Œä¸ºç»Ÿè®¡ -->
        <div class="card shadow-sm">
            <div class="card-body p-3 d-flex justify-content-between text-center">
                <div class="flex-fill">
                    <small class="text-muted d-block mb-1">çŒœé¢˜</small>
                    <div class="fw-bold text-danger fs-5">{{ behavior_totals.guess_count }}</div>
                </div>
                <div class="flex-fill">
                    <small class="text-muted d-block mb-1">æŠ„é¢˜</small>
                    <div class="fw-bold text-danger fs-5">{{ behavior_totals.copy_count }}</div>
                </div>
                <div class="flex-fill">
                    <small class="text-muted d-block mb-1">æ‰“é—¹</small>
                    <div class="fw-bold text-danger fs-5">{{ behavior_totals.noisy_count }}</div>
                </div>
                <div class="flex-fill">
                    <small class="text-muted d-block mb-1">èµ°ç¥</small>
                    <div class="fw-bold text-danger fs-5">{{ behavior_totals.distracted_count }}</div>
                </div>
            </div>
        </div>

        <!-- ä¸ªæ€§åŒ–åé¦ˆ -->
        {% if personalized_feedback %}
        <div class="card border-info shadow-sm">
            <div class="card-body p-3">
                <i class="fas fa-comment-dots text-info me-2"></i>
                <span>{{ personalized_feedback.focus_feedback }}</span>
            </div>
        </div>
        {% endif %}

        <!-- ç­çº§è¶‹åŠ¿ -->
        <div class="card shadow-sm">
            <div class="card-header py-2 bg-light"><strong><i class="fas fa-chart-line me-1"></i>ç­çº§æ•´ä½“è¶‹åŠ¿</strong></div>
            <div class="card-body p-3">
                <canvas id="trendChartDesktop" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- å³ä¾§å†…å®¹åŒºåŸŸ - å­¦ä¹ å‚ä¸è®°å½• -->
    <div class="report-right">
        <div class="card shadow-sm" style="height: calc(100vh - 40px); display: flex; flex-direction: column;">
            <div class="card-header py-2 bg-light">
                <strong><i class="fas fa-history me-1"></i>å­¦ä¹ å‚ä¸è®°å½•</strong>
            </div>
            <div class="scrollable-container" style="flex: 1; overflow-y: auto;">
                <div class="list-group list-group-flush" style="overflow-x: hidden;">
                    {% for round_num in range(1, class_total_rounds + 1) %}
                    {% set round_submission = student_submissions|selectattr('round', 'equalto', round_num)|first %}
                    {% set round_stat = class_round_stats|selectattr('round', 'equalto', round_num)|first %}
                    {% set round_accuracy = round_stat.accuracy if round_stat else 0 %}
                    {# è·å–è¯¥è½®çš„åˆ†å€¼å’Œéš¾åº¦ - student_submissions_viewåŒ…å«æ‰€æœ‰è½®æ¬¡ä¿¡æ¯ #}
                    {% set round_view = student_submissions_view|selectattr('round', 'equalto', round_num)|first %}
                    {% set q_score = round_view.question_score if round_view and round_view.question_score else (round_submission.question_score if round_submission and round_submission.question_score else 1) %}
                    {# è®¡ç®—éš¾åº¦ #}
                    {% set qs = q_score %}
                    {% set diff = 'åŸºç¡€' %}
                    {% if qs >= 6 %}{% set diff = 'æéš¾' %}
                    {% elif qs == 5 %}{% set diff = 'å¾ˆéš¾' %}
                    {% elif qs == 4 %}{% set diff = 'è¾ƒéš¾' %}
                    {% elif qs == 3 %}{% set diff = 'ä¸­ç­‰' %}
                    {% elif qs == 2 %}{% set diff = 'ç®€å•' %}
                    {% else %}{% set diff = 'åŸºç¡€' %}{% endif %}
                    <div class="list-group-item py-3" style="overflow-x: hidden; width: 100%; max-width: 100%;">
                        <div class="round-record-item">
                            {# ç¬¬ä¸€è¡Œï¼šåŸºæœ¬ä¿¡æ¯ #}
                            <div class="round-record-row1">
                                {# åˆ—1: è½®æ¬¡å· #}
                                <div class="round-number">
                                    <span class="fw-bold">ç¬¬{{ round_num }}è½®</span>
                                </div>
                                {# åˆ—2: å‚ä¸çŠ¶æ€ #}
                                <div class="round-status">
                                    {% if round_submission and round_submission.violation_type %}
                                        <span class="badge bg-danger">{{ round_submission.violation_type }}</span>
                                    {% elif round_submission and round_submission.answer is not none and round_submission.answer|string|trim %}
                                        <span class="badge bg-primary">å‚ä¸</span>
                                    {% else %}
                                        <span class="badge bg-secondary">æœªå‚ä¸</span>
                                    {% endif %}
                                </div>
                                {# åˆ—3: æ­£ç¡®/é”™è¯¯ #}
                                <div class="round-correct">
                                    {% if round_submission and round_submission.answer is not none and round_submission.answer|string|trim and not round_submission.violation_type %}
                                        <span class="badge bg-{{ 'success' if round_submission.is_correct else 'danger' }}">{{ 'âœ“' if round_submission.is_correct else 'âœ—' }}</span>
                                    {% else %}
                                        <span class="badge bg-transparent text-transparent">-</span>
                                    {% endif %}
                                </div>
                                {# åˆ—4: å¾—åˆ† #}
                                <div class="round-score">
                                    <span class="badge bg-warning text-dark">{{ q_score }}åˆ†</span>
                                </div>
                                {# åˆ—5: éš¾åº¦ #}
                                <div class="round-difficulty">
                                    <span class="badge bg-secondary">{{ diff }}</span>
                                </div>
                                {# åˆ—6: é€Ÿåº¦ #}
                                <div class="round-speed">
                                    {% if round_submission and round_submission.speed_level and round_submission.answer is not none and round_submission.answer|string|trim %}
                                        <span class="badge bg-info text-dark">{{ round_submission.speed_level }}</span>
                                    {% else %}
                                        <span class="badge bg-transparent text-transparent">-</span>
                                    {% endif %}
                                </div>
                                {# åˆ—7: æ—¶é—´ #}
                                <div class="round-time">
                                    {% if round_submission and round_submission.answer is not none and round_submission.answer|string|trim %}
                                        <span class="badge bg-primary text-white">{{ "%.1f"|format(round_submission.answer_time) }}ç§’</span>
                                    {% else %}
                                        <span class="badge bg-transparent text-transparent">-</span>
                                    {% endif %}
                                </div>
                            </div>
                            {# ç¬¬äºŒè¡Œï¼šæ­£ç¡®ç‡ï¼ˆä¸å‚ä¸çŠ¶æ€å¯¹é½ï¼‰ #}
                            <div class="round-record-row2">
                                <div class="round-accuracy-container">
                                    <span class="text-muted small">æ­£ç¡®ç‡ï¼š</span>
                                    <div class="progress" style="height:8px; width: 100px; flex-shrink: 0;">
                                        <div class="progress-bar bg-success" style="width: {{ round_accuracy }}%; background-color: #28a745 !important;"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.1f"|format(round_accuracy) }}%</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const classRoundStats = {{ class_round_stats|tojson }};
const trendCtx = document.getElementById('trendChartDesktop').getContext('2d');
new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: classRoundStats.map(s => `ç¬¬${s.round}è½®`),
        datasets: [{
            label: 'å¾—åˆ†ç‡(%)',
            data: classRoundStats.map(s => s.accuracy),
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.15)',
            tension: .3,
            borderWidth: 2
        }, {
            label: 'å‚ä¸ç‡(%)',
            data: classRoundStats.map(s => s.participation_rate),
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.15)',
            tension: .3,
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        }
    }
});
</script>
{% endblock %}
